<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jal Jagran - Modern Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Ant-Path Plugin for animated polylines -->
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>


    <!-- Custom Styles -->
    <style>
body { font-family: 'Plus Jakarta Sans', sans-serif; background: linear-gradient(135deg, #f0f2f5 0%, #e0e7ff 100%); }
.tab-content { display: none; animation: fadeIn 0.5s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.sidebar-link.active { background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%); color: #fff; box-shadow: 0 4px 12px 0 rgba(6,182,212,0.15); }
.sidebar-link.active i { color: #fff; }
.sidebar-link { transition: all 0.2s ease-in-out; }
.sidebar-link:hover { background: linear-gradient(90deg, #818cf8 0%, #38bdf8 100%); color: #fff; }
/* Custom scrollbar for better aesthetics */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #818cf8 0%, #06b6d4 100%); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
/* Loader animation */
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #06b6d4; border-right: 4px solid #818cf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.show { transform: scale(1); }
.pulse-live { animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
/* Stat card backgrounds */
.stat-card-gradient-1 { background: linear-gradient(135deg, #818cf8 0%, #38bdf8 100%); }
.stat-card-gradient-2 { background: linear-gradient(135deg, #34d399 0%, #06b6d4 100%); }
.stat-card-gradient-3 { background: linear-gradient(135deg, #fbbf24 0%, #f472b6 100%); }
.stat-card-gradient-4 { background: linear-gradient(135deg, #f87171 0%, #fbbf24 100%); }
.custom-marker-base {
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    width: 28px !important;
    height: 28px !important;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
}
.custom-marker-base:hover {
    transform: scale(1.2);
}
.custom-marker-base i {
    color: white;
}
.custom-marker-green { background-color: #10B981; }
.custom-marker-red { background-color: #EF4444; }
.custom-marker-yellow { background-color: #F59E0B; }
.custom-marker-blue { background-color: #3B82F6; }
.legend {
    padding: 8px 12px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 8px;
    line-height: 24px;
    color: #333;
    max-width: 200px;
}
.legend i {
    vertical-align: middle;
    margin-right: 8px;
}
.legend .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
}
.legend .legend-marker {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    flex-shrink: 0;
}
/* Mobile-specific margin for the map legend */
@media (max-width: 768px) {
    .leaflet-bottom.leaflet-left {
        margin-left: 10px;
        margin-bottom: 10px;
    }
}

.loader-sm { border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }

    </style>
    <style>
        .selected-village-marker {
            transform: scale(1.5);
            border: 3px solid #0ea5e9 !important; /* sky-500 */
            z-index: 1000 !important;
        }
    </style>
    <style>
    /* Mobile Optimization */
    @media (max-width: 768px) {
        main {
            padding: 1rem; /* Keep padding for mobile */
        }
        /* The sidebar is now a proper mobile menu, not a top bar */
        #sidebar {
            transform: translateX(-100%);
            position: fixed; /* Ensure it's fixed for overlay effect */
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.show {
            /* This class will be toggled by JS to show the sidebar */
            transform: translateX(0);
        }
        .tab-content {
            padding-top: 1rem; /* Adjust top padding for mobile content */
        }
        table {
            font-size: 0.9rem;
            width: 100%;
            overflow-x: auto; /* This is good for wide tables */
            display: block;
        }
        /* Removed .grid override; Tailwind classes are better */

        /* Chart.js responsiveness is now handled in JS */
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        .rounded-2xl {
            border-radius: 1rem;
        }
        .stat-card-gradient-1, .stat-card-gradient-2, .stat-card-gradient-3, .stat-card-gradient-4 {
            padding: 1rem;
        }
        input[type="text"], input[type="email"], select, textarea {
            font-size: 1rem;
            padding: 0.5rem 0.75rem;
        }
        button, .sidebar-link {
            min-height: 44px; /* Minimum touch target size */
            padding: 0.5rem 1rem;
        }
    }
</style>
</head>
<body class="flex flex-col md:flex-row antialiased">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="w-64 bg-blue-900 text-blue-100 flex flex-col h-screen sticky top-0 shadow-lg md:translate-x-0 transition-transform duration-300 ease-in-out z-50">
        <div class="p-6 flex items-center space-x-3 border-b border-blue-800">
            <div class="bg-blue-500 p-2 rounded-lg">
                <i data-lucide="droplets" class="w-6 h-6 text-white"></i>
            </div>
            <span class="font-bold text-xl text-white">Jal Jagran</span>
        </div>
        <nav class="mt-6 flex-1 px-4 space-y-2">
            <a href="#overview" data-tab="overview" role="tab" aria-selected="true" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-semibold">Overview</span>
            </a>
            <a href="#households" data-tab="households" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="font-semibold">Households</span>
            </a>
            <a href="#live-data" data-tab="live-data" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span class="font-semibold">Live Data</span>
            </a>
            <a href="#ai-insights" data-tab="ai-insights" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                <span class="font-semibold">AI Insights</span>
            </a>
            <a href="#map" data-tab="map" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="map" class="w-5 h-5"></i>
                <span class="font-semibold">Map View</span>
            </a>
            <a href="#grievances" data-tab="grievances" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="alert-octagon" class="w-5 h-5"></i>
                <span class="font-semibold">Grievances</span>
            </a>
            <a href="#logs" data-tab="logs" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="font-semibold">System Logs</span>
            </a>
            <a href="#contact" data-tab="contact" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="mail-question" class="w-5 h-5"></i>
                <span class="font-semibold">Support</span>
            </a>
        </nav>
        <div class="p-4 border-t border-blue-800">
            <div class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/60a5fa/FFFFFF?text=A" alt="Admin" class="rounded-full">
                <div>
                    <p class="font-semibold text-white text-sm">Admin User</p>
                    <p class="text-xs text-blue-300">District Officer</p>
                </div>
            </div>
        </div>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-4">
                <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-200 rounded-full" aria-label="Open sidebar menu" aria-controls="sidebar" aria-expanded="false">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div>
                    <h1 id="header-title" class="text-3xl font-bold text-gray-800" tabindex="-1">Overview</h1>
                    <p class="text-gray-500 mt-1">Welcome back! Here's a summary of the water supply system.</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                 <div class="relative">
                    <label for="search-input" class="sr-only">Search</label>
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Search..." class="pl-10 pr-4 py-2 w-full md:w-64 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>
                <button class="relative p-2 text-gray-600 hover:bg-gray-200 rounded-full" aria-label="View notifications">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500" aria-hidden="true"></span>
                    <span class="sr-only">You have new notifications</span>
                </button>
            </div>
        </header>
        <!-- Tab Content Area -->
        <div id="tab-container">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="mb-8">
                    <!-- Panchayat & Village Selector -->
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <div>
                            <label for="panchayat-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Panchayat</label>
                            <select id="panchayat-selector" class="w-full md:w-56 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <!-- Panchayat options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="village-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Village</label>
                            <select id="village-selector" class="w-full md:w-56 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <!-- Village options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Stat Card 1 -->
                    <div class="stat-card-gradient-1 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                        <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="home" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Total Households</p>
                            <h3 id="total-households" class="text-3xl font-bold">1,250</h3>
                        </div>
                    </div>
                    <!-- Stat Card 2 -->
                    <div class="stat-card-gradient-2 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                        <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="plug-zap" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Active Connections</p>
                            <h3 id="active-connections" class="text-3xl font-bold">1,220</h3>
                        </div>
                    </div>
                    <!-- Stat Card 3 -->
                    <div class="stat-card-gradient-3 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                         <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="target" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Coverage</p>
                            <h3 id="coverage" class="text-3xl font-bold">98%</h3>
                        </div>
                    </div>
                     <!-- Stat Card 4 -->
                    <div class="stat-card-gradient-4 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                         <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="alert-circle" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Active Alerts</p>
                            <h3 id="active-alerts" class="text-3xl font-bold">3</h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8 items-start">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Weekly Water Supplied (kL)</h3>
                        <canvas id="waterChart" role="img" aria-label="Bar chart showing weekly water supplied in kiloliters"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">System Status</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Pump P-1</span>
                                <span id="pump-p1-status-overview" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">Operational</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Pump P-2</span>
                                <span id="pump-p2-status-overview" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">Operational</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Valve V-1 (Zone A)</span>
                                <span id="valve-v1-status-overview" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">Open</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Valve V-2 (Zone B)</span>
                                <span id="valve-v2-status-overview" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">Open</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Filter Unit A</span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">Operational</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Reservoir Level</span>
                                <div class="w-1/2 bg-gray-200 rounded-full h-2.5">
                                    <div id="reservoir-level" class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="font-semibold text-gray-700">85%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Households Tab -->
            <div id="households" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                            Household Water Statistics 
                            <span class="ml-3 flex items-center text-xs font-semibold text-green-600 pulse-live"><span class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></span>LIVE</span>
                        </h3>
                         <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
                             <i data-lucide="plus" class="w-5 h-5"></i>
                             <span>Add Household</span>
                         </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4 font-semibold text-gray-600">House ID</th>
                                    <th class="p-4 font-semibold text-gray-600">Weekly Usage</th>
                                    <th class="p-4 font-semibold text-gray-600">Avg. Daily Need</th>
                                    <th class="p-4 font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="households-table-body">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H001</td>
                                    <td class="p-4 text-gray-600">125 L</td>
                                    <td class="p-4 text-gray-600">130 L</td>
                                    <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H001')">Details</button></td>
                                </tr>
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H002</td>
                                    <td class="p-4 text-gray-600">163 L</td>
                                    <td class="p-4 text-gray-600">150 L</td>
                                    <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H002')">Details</button></td>
                                </tr>
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H003</td>
                                    <td class="p-4 text-gray-600">95 L</td>
                                    <td class="p-4 text-gray-600">140 L</td>
                                    <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H003')">Details</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Live Data Tab -->
            <div id="live-data" class="tab-content">
                <!-- Sub-tabs for Live Data -->
                <div class="mb-6 flex space-x-2 border-b border-gray-200">
                    <button class="live-subtab-btn px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-semibold focus:outline-none" data-subtab="live-charts">Charts</button>
                </div>
                <!-- Charts Subtab -->
                <div id="live-charts" class="live-subtab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Chlorine Levels (mg/L)</h3>
                            <canvas id="chlorineChart" role="img" aria-label="Line chart showing daily chlorine levels in mg/L"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">FHTC Growth</h3>
                            <canvas id="fhtcChart" role="img" aria-label="Line chart showing FHTC connection growth over months"></canvas>
                        </div>
                    </div>
                    <div class="mt-6 bg-white p-6 rounded-2xl shadow-md">
                      <h3 class="text-lg font-semibold text-gray-700 mb-4">Daily Routine Checks</h3>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4">
                          <div class="flex items-center justify-between">
                            <span class="text-gray-600">Pump Running Hours Today:</span>
                            <span id="daily-pump-hours" class="font-bold text-blue-600">8.5 hrs</span>
                          </div>
                          <div class="flex items-center justify-between">
                            <span class="text-gray-600">Valve Status Check:</span>
                            <span id="valve-check-status" class="font-bold text-green-600">OPEN</span>
                          </div>
                          <div class="flex items-center justify-between">
                            <span class="text-gray-600">Leak Detection:</span>
                            <span id="leak-detection-status" class="font-bold text-green-600">No Leaks Detected</span>
                          </div>
                          <div class="flex items-center justify-between">
                            <span class="text-gray-600">Last Water Quality Test:</span>
                            <span id="last-quality-test" class="font-bold text-blue-600">Today 10:00 AM</span>
                          </div>
                        </div>
                        <div class="space-y-4">
                          <button id="perform-check-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                            <i data-lucide="check-circle" class="mr-2 h-5 w-5"></i>Perform Routine Check
                          </button>
                          <button id="reset-checks-btn" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition flex items-center justify-center">
                            <i data-lucide="rotate-ccw" class="mr-2 h-5 w-5"></i>Reset Daily Checks
                          </button>
                          <div id="check-alert" class="text-sm text-red-600 hidden">Alert: Anomalies detected! Check sensors.</div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-6 bg-white p-6 rounded-2xl shadow-md">
                      <h3 class="text-lg font-semibold text-gray-700 mb-4">Real-Time Sensor Simulation</h3>
                      <!-- Simulation Control Buttons -->
                      <div class="flex flex-wrap gap-2 mb-4 border-b pb-4">
                          <button id="sim-normal-btn" class="simulation-btn bg-blue-600 text-white px-3 py-1.5 text-sm font-semibold rounded-lg shadow-sm">Normal</button>
                          <button id="sim-leak-btn" class="simulation-btn bg-gray-200 text-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg">Simulate Leak</button>
                          <button id="sim-pump-failure-btn" class="simulation-btn bg-gray-200 text-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg">Simulate Pump Failure</button>
                          <div id="simulation-status" class="flex items-center ml-auto">
                              <span class="w-3 h-3 bg-green-500 rounded-full mr-2 pulse-live"></span>
                              <span class="text-sm font-semibold text-gray-600">Normal Operation</span>
                          </div>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-4">
                            <div>
                                <p class="font-medium text-gray-600 mb-1">Pump P-1 Status:</p>
                                <p id="pump-p1-status" class="font-bold text-green-600">ON</p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-600 mb-1">Pump P-2 Status:</p>
                                <p id="pump-p2-status" class="font-bold text-green-600">ON</p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-600 mb-1">Valve V-1 (Zone A):</p>
                                <p id="valve-v1-status" class="font-bold text-green-600">OPEN</p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-600 mb-1">Valve V-2 (Zone B):</p>
                                <p id="valve-v2-status" class="font-bold text-green-600">OPEN</p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-600 mb-1">Reservoir Level:</p>
                                <div id="reservoir-level-display" class="font-bold text-blue-600">85%</div>
                            </div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><canvas id="flowRateChart" height="200" role="img" aria-label="Real-time flow rate chart"></canvas></div>
                            <div><canvas id="pressureChart" height="200" role="img" aria-label="Real-time pressure chart"></canvas></div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="ai-insights" class="tab-content"> 
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gemini AI Weekly Summary -->
                    <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-blue-500 flex flex-col">
                        <div class="flex items-center space-x-3 mb-3">
                            <i data-lucide="lightbulb" class="w-6 h-6 text-blue-500"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Weekly Summary (Gemini AI)</h3>
                        </div>
                        <button id="generate-summary-btn" class="mb-3 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center space-x-2 disabled:bg-blue-300">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                            <span>Generate Summary</span>
                        </button>
                        <div id="summary-output" class="bg-blue-50 p-4 rounded-lg text-gray-700 min-h-[200px] whitespace-pre-wrap flex items-center justify-center">
                            Click the button to generate an AI-powered summary of the week's activities and data trends.
                        </div>
                    </div>
            <!-- Gemini AI Maintenance Forecast -->
            <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-purple-500 flex flex-col" id="maintenance-forecast-section">
                <div class="flex items-center space-x-3 mb-3">
                    <i data-lucide="cpu" class="w-6 h-6 text-purple-500"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Predictive Maintenance Forecast</h3>
                </div>
                <button id="generate-forecast-btn" class="mb-3 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition flex items-center justify-center space-x-2 disabled:bg-purple-300">
                    <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                    <span>Generate Forecast</span>
                </button>
                <!-- KPI CARDS for Predictive Maintenance Risk - Optimized for mobile -->
                <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3">
                  <div class="bg-red-50 p-2 rounded text-center shadow">
                    <div class="text-xs text-gray-600">High Risk</div>
                    <div id="highRiskCount" class="text-2xl font-bold text-red-600">0</div>
                  </div>
                  <div class="bg-yellow-50 p-2 rounded text-center shadow">
                    <div class="text-xs text-gray-600">Upcoming Maintenance</div>
                    <div id="upcomingMaintCount" class="text-2xl font-bold text-yellow-600">0</div>
                  </div>
                  <div class="bg-green-50 p-2 rounded text-center shadow">
                    <div class="text-xs text-gray-600">Healthy Components</div>
                    <div id="healthyCount" class="text-2xl font-bold text-green-600">0</div>
                  </div>
                  <div class="bg-blue-50 p-2 rounded text-center shadow">
                    <div class="text-xs text-gray-600">Total Components</div>
                    <div id="totalComponents" class="text-2xl font-bold text-blue-600">4</div>
                  </div>
                  <div class="bg-purple-50 p-2 rounded text-center shadow">
                    <div class="text-xs text-gray-600">Avg Risk Score</div>
                    <div id="avgRiskScore" class="text-2xl font-bold text-purple-600">0</div>
                  </div>
                </div>
                <!-- Historical Risk Trends Chart -->
                <div class="mt-4">
                  <h4 class="text-md font-semibold text-gray-800 mb-2">Risk Trends (Last 7 Days)</h4>
                  <canvas id="riskTrendsChart" height="150" role="img" aria-label="Line chart showing the average component risk score over the last 7 days"></canvas>
                </div>
                <!-- Enhanced Predictive Maintenance Table -->
                <div class="overflow-x-auto" id="aiInsightsTable">
                  <!-- Predictive maintenance output will be inserted here by JS -->
                </div>
            </div>
                </div>
            </div>

            <!-- Map Tab -->
            <div id="map" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2 md:mb-0">Geographical Overview of Water Assets</h3>
                        <!-- Map Filters -->
                        <div id="map-filters" class="flex flex-wrap gap-2 md:gap-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" data-asset-type="Pump" class="map-filter-checkbox h-4 w-4 rounded text-red-600 focus:ring-red-500" checked>
                                <span class="text-sm font-medium text-gray-700">Pumps</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" data-asset-type="Valve" class="map-filter-checkbox h-4 w-4 rounded text-yellow-600 focus:ring-yellow-500" checked>
                                <span class="text-sm font-medium text-gray-700">Valves</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" data-asset-type="Filter" class="map-filter-checkbox h-4 w-4 rounded text-blue-600 focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">Filters</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" data-asset-type="Sensor" class="map-filter-checkbox h-4 w-4 rounded text-green-600 focus:ring-green-500" checked>
                                <span class="text-sm font-medium text-gray-700">Sensors</span>
                            </label>
                        </div>
                    </div>
                    <div id="map-container" class="w-full h-[600px] rounded-lg z-10"></div>
                </div>
            </div>

            <!-- Grievances Tab -->
            <div id="grievances" class="tab-content">
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Report an Issue</h3>
                        <form id="grievance-form" class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Issue Type</label>
                                <select class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option>Pipe Leakage</option>
                                    <option>No Water Supply</option>
                                    <option>Contaminated Water</option>
                                    <option>Billing Issue</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Location / Landmark</label>
                                <input type="text" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Near Ward 2 Park">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Details</label>
                                <textarea class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" placeholder="Provide a brief description..."></textarea>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Attach Photos / Files</label>
                                <input type="file" id="grievance-attachment" multiple class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <div id="attachment-preview" class="mt-2 flex space-x-2 flex-wrap"></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center justify-center">
                                <i data-lucide="sparkles" class="mr-2 h-5 w-5"></i>Analyze & Suggest Action Plan
                            </button>
                        </form>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Live Grievance Tracker</h3>
                         <div id="grievance-tracker" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2 md:mb-0">System Event Logs</h3>
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                            <div class="relative w-full md:w-auto">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                                <input type="text" id="log-search-input" placeholder="Search logs..." class="pl-9 pr-3 py-2 w-full border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                            </div>
                            <div id="log-filter-buttons" class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                                <button data-level="All" class="log-filter-btn active-filter bg-white text-blue-600 shadow-sm px-3 py-1 text-sm font-semibold rounded-md">All</button>
                                <button data-level="ERROR" class="log-filter-btn px-3 py-1 text-sm font-semibold rounded-md">Errors</button>
                                <button data-level="WARN" class="log-filter-btn px-3 py-1 text-sm font-semibold rounded-md">Warnings</button>
                                <button data-level="INFO" class="log-filter-btn px-3 py-1 text-sm font-semibold rounded-md">Info</button>
                            </div>
                            <button id="analyze-logs-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-2 disabled:bg-indigo-300"><i data-lucide="brain-circuit" class="w-5 h-5"></i><span class="hidden sm:inline">Analyze</span></button>
                        </div>
                    </div>
                    <ul id="logs-list" class="space-y-3 mb-6">
                        <li class="border p-3 rounded-lg bg-gray-50 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">[INFO] System initialized successfully.</p>
                                <p class="text-sm text-gray-500">2025-10-06 09:12:45</p>
                            </div>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">INFO</span>
                        </li>
                        <li class="border p-3 rounded-lg bg-gray-50 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">[WARN] Pump P-2 running above normal temperature.</p>
                                <p class="text-sm text-gray-500">2025-10-06 09:15:23</p>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">WARN</span>
                        </li>
                        <li class="border p-3 rounded-lg bg-gray-50 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">[ERROR] Sensor S-4 data timeout detected.</p>
                                <p class="text-sm text-gray-500">2025-10-06 09:17:10</p>
                            </div>
                            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">ERROR</span>
                        </li>
                        <li class="border p-3 rounded-lg bg-gray-50 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">[INFO] Water Quality Check completed successfully.</p>
                                <p class="text-sm text-gray-500">2025-10-06 09:20:02</p>
                            </div>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">INFO</span>
                        </li>
                        <li class="border p-3 rounded-lg bg-gray-50 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">[WARN] Reservoir Level dropped below 40% threshold.</p>
                                <p class="text-sm text-gray-500">2025-10-06 09:25:48</p>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">WARN</span>
                        </li>
                    </ul>
                    <!-- AI Log Analysis Output -->
                    <div id="log-analysis-section" class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center"><i data-lucide="search" class="w-5 h-5 mr-2 text-indigo-500"></i>AI Log Analysis</h3>
                        <div id="log-analysis-output" class="bg-indigo-50 p-4 rounded-lg text-gray-700 min-h-[150px] whitespace-pre-wrap flex items-center justify-center">
                            Click the "Analyze Logs" button to identify recurring issues and patterns from the system logs.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Tab -->
            <div id="contact" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- FAQ Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Frequently Asked Questions</h3>
                        <p class="text-gray-500 mb-6">Find quick answers to common questions about the dashboard.</p>
                        <div id="faq-container" class="space-y-4">
                            <!-- FAQs will be dynamically inserted here -->
                        </div>
                    </div>
                    <!-- Contact Form Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Still Have Questions?</h3>
                        <p class="text-gray-500 mb-6">Fill out the form below and our support team will get back to you.</p>
                        <form id="contact-form" class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Your Name</label>
                                    <input type="text" id="contact-name" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="John Doe" required>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" id="contact-email" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="you@example.com" required>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Subject</label>
                                <input type="text" id="contact-subject" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Technical Support" required>
                            </div>
                            <div>
                               <label class="text-sm font-medium text-gray-700">Message</label>
                               <textarea id="contact-message" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="5" placeholder="Your message here..." required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center disabled:bg-blue-400 disabled:cursor-not-allowed">
                                <span class="button-text">Send Message</span>
                                <span class="button-loader hidden ml-2"><div class="loader-sm"></div></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        window.closeAIGrievanceModal = function() {
            const modal = document.getElementById('ai-grievance-modal'); // This is the correct modal ID
            modal.classList.add('hidden');
            modal.classList.remove('show');
        }
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide Icons
            lucide.createIcons();

            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('sidebar');
            mobileMenuBtn?.addEventListener('click', () => {
                const isExpanded = sidebar.classList.toggle('show');
                mobileMenuBtn.setAttribute('aria-expanded', isExpanded);
            });

            // --- Multilanguage Support with 5 Languages ---
            const translations = {
                en: {
                    overview: "Overview",
                    households: "Households",
                    liveData: "Live Data",
                    aiInsights: "AI Insights",
                    mapView: "Map View",
                    grievances: "Grievances",
                    contact: "Support",
                    welcomeMsg: "Welcome back! Here's a summary of the water supply system.",
                    totalHouseholds: "Total Households",
                    activeConnections: "Active Connections",
                    coverage: "Coverage",
                    activeAlerts: "Active Alerts",
                    weeklyWater: "Weekly Water Supplied (kL)",
                    systemStatus: "System Status",
                    pumpStatus: "Pump",
                    valveStatus: "Valve",
                    reservoirLevel: "Reservoir Level",
                    generateSummary: "Generate Summary",
                    predictiveMaintenance: "Predictive Maintenance Forecast",
                    analyzeLogs: "Analyze Logs",
                    searchPlaceholder: "Search..."
                },
                hi: {
                    overview: "अवलोकन",
                    households: "गृहस्थी",
                    liveData: "लाइव डेटा",
                    aiInsights: "एआई अंतर्दृष्टि",
                    mapView: "मानचित्र दृश्य",
                    grievances: "शिकायतें",
                    contact: "सहायता",
                    welcomeMsg: "स्वागत है! जल आपूर्ति प्रणाली का सारांश यहां है।",
                    totalHouseholds: "कुल गृहस्थी",
                    activeConnections: "सक्रिय कनेक्शन",
                    coverage: "कवरेज",
                    activeAlerts: "सक्रिय चेतावनी",
                    weeklyWater: "साप्ताहिक आपूर्ति (किलोलीटर में)",
                    systemStatus: "सिस्टम स्थिति",
                    pumpStatus: "पंप",
                    valveStatus: "वाल्व",
                    reservoirLevel: "भंडार स्तर",
                    generateSummary: "सारांश उत्पन्न करें",
                    predictiveMaintenance: "पूर्वानुमानित रखरखाव पूर्वानुमान",
                    analyzeLogs: "लॉग विश्लेषण करें",
                    searchPlaceholder: "लॉग खोजें..."
                },
                mr: {
                    overview: "आढावा",
                    households: "घराणे",
                    liveData: "थेट डेटा",
                    aiInsights: "एआय अंतर्दृष्टी",
                    mapView: "नकाशा दृश्य",
                    grievances: "तक्रारी",
                    contact: "सहाय्यता",
                    welcomeMsg: "पुन्हा स्वागत आहे! जलपुरवठा प्रणालीचा आढावा येथे आहे.",
                    totalHouseholds: "एकूण घराणे",
                    activeConnections: "सक्रिय कनेक्शन्स",
                    coverage: "व्याप्ती",
                    activeAlerts: "सक्रिय इशारे",
                    weeklyWater: "साप्ताहिक पुरवठा (किलोलीटर्स)",
                    systemStatus: "सिस्टम स्थिती",
                    pumpStatus: "पंप",
                    valveStatus: "वाल्व",
                    reservoirLevel: "साठा पातळी",
                    generateSummary: "सारांश तयार करा",
                    predictiveMaintenance: "पूर्वानुमानित देखभाल",
                    analyzeLogs: "लॉग विश्लेषण करा",
                    searchPlaceholder: "लॉग शोधा..."
                },
                ta: {
                    overview: "கண்ணோட்டம்",
                    households: "குடியிருப்புகள்",
                    liveData: "நேரடி தரவு",
                    aiInsights: "ஏ.ஐ. நுண்ணறிவு",
                    mapView: "வரைபடக் காட்சி",
                    grievances: "புகார்கள்",
                    contact: "ஆதரவு",
                    welcomeMsg: "மீண்டும் வரவேற்கிறோம்! நீர் வழங்கல் அமைப்பின் சுருக்கம் இங்கே உள்ளது.",
                    totalHouseholds: "மொத்த குடியிருப்புகள்",
                    activeConnections: "செயலில் உள்ள இணைப்புகள்",
                    coverage: "கவரேஜ்",
                    activeAlerts: "செயலில் உள்ள எச்சரிக்கைகள்",
                    weeklyWater: "சப்தாந்த நீர் வழங்கல் (கிலோலிட்டர்)",
                    systemStatus: "கணினி நிலை",
                    pumpStatus: "பம்ப்",
                    valveStatus: "வால்வ்",
                    reservoirLevel: "இரக்கம் நிலை",
                    generateSummary: "சுருக்கத்தை உருவாக்கவும்",
                    predictiveMaintenance: "முன்கூட்டியே பராமரிப்பு முன்னறிவிப்பு",
                    analyzeLogs: "லாக் பகுப்பாய்வு",
                    searchPlaceholder: "லாக்கள் தேடவும்..."
                },
                kn: {
                    overview: "ಸಮೀಕ್ಷೆ",
                    households: "ಗೃಹಗಳು",
                    liveData: "ನೇರ ಡೇಟಾ",
                    aiInsights: "ಎಐ ಅಂತರ್ದೃಷ್ಟಿ",
                    mapView: "ನಕ್ಷೆ ನೋಟ",
                    grievances: "ಗೆಳವಣಿಗೆಗಳು",
                    contact: "ಸಹಾಯ",
                    welcomeMsg: "ಮರುಸ್ವಾಗತ! ನೀರಿನ ಪೂರೈಕೆ ವ್ಯವಸ್ಥೆಯ ಸಂಕ್ಷಿಪ್ತ ವರದಿ ಇಲ್ಲಿದೆ.",
                    totalHouseholds: "ಒಟ್ಟು ಗೃಹಗಳು",
                    activeConnections: "ಸಕ್ರಿಯ ಸಂಪರ್ಕಗಳು",
                    coverage: "ಕವರ್",
                    activeAlerts: "ಸಕ್ರಿಯ ಎಚ್ಚರಿಕೆಗಳು",
                    weeklyWater: "ವಾರ್ಷಿಕ ನೀರಿನ ಪೂರೈಕೆ (ಕೆ.ಎಲ್)",
                    systemStatus: "ಸಿಸ್ಟಮ್ ಸ್ಥಿತಿ",
                    pumpStatus: "ಪಂಪ್",
                    valveStatus: "ವಾಲ್ವ್",
                    reservoirLevel: "ಅಂಗಡಿಗಳ ಮಟ್ಟ",
                    generateSummary: "ಸಾರಾಂಶವನ್ನು ರಚಿಸಿ",
                    predictiveMaintenance: "ಭವಿಷ್ಯ ನಿರ್ವಹಣೆ ಮುನ್ನೋಟ",
                    analyzeLogs: "ಲಾಗ್ ವಿಶ್ಲೇಷಣೆ",
                    searchPlaceholder: "ಲಾಗ್ ಹುಡುಕಿ..."
                }
            };

            // Language Selection Button with Flags
            const langButtonContainer = document.createElement('div');
            langButtonContainer.className = "relative ml-4";

            const langButton = document.createElement('button');
            langButton.id = "language-button";
            langButton.className = "flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full shadow-lg hover:scale-105 transition-transform duration-300 focus:outline-none";
            langButton.innerHTML = `<span id="current-lang">EN</span> <i data-lucide="chevron-down" class="w-4 h-4"></i>`;
            langButtonContainer.appendChild(langButton);

            const langDropdown = document.createElement('div');
            langDropdown.id = "language-dropdown";
            langDropdown.className = "absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg hidden z-50";
            langDropdown.innerHTML = `
                <button class="lang-option flex items-center gap-2 px-4 py-2 w-full hover:bg-gray-100" data-lang="en">🇬🇧 English</button>
                <button class="lang-option flex items-center gap-2 px-4 py-2 w-full hover:bg-gray-100" data-lang="hi">🇮🇳 हिंदी</button>
                <button class="lang-option flex items-center gap-2 px-4 py-2 w-full hover:bg-gray-100" data-lang="mr">🇮🇳 मराठी</button>
                <button class="lang-option flex items-center gap-2 px-4 py-2 w-full hover:bg-gray-100" data-lang="ta">🇮🇳 தமிழ்</button>
                <button class="lang-option flex items-center gap-2 px-4 py-2 w-full hover:bg-gray-100" data-lang="kn">🇮🇳 ಕನ್ನಡ</button>
            `;
            langButtonContainer.appendChild(langDropdown);

            document.querySelector('header .flex.items-center.space-x-4')?.appendChild(langButtonContainer);

            // Toggle dropdown visibility
            langButton.addEventListener('click', () => {
                langDropdown.classList.toggle('hidden');
            });

            // Language option click
            langDropdown.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    document.getElementById('current-lang').textContent = lang.toUpperCase();
                    setLanguage(lang);
                    langDropdown.classList.add('hidden');
                });
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (!langButtonContainer.contains(e.target)) {
                    langDropdown.classList.add('hidden');
                }
            });

            // Function to update all translatable elements
            function setLanguage(lang) {
                const t = translations[lang];
                if(!t) return;

                // Sidebar
                document.querySelector('[data-tab="overview"] span').textContent = t.overview;
                document.querySelector('[data-tab="households"] span').textContent = t.households;
                document.querySelector('[data-tab="live-data"] span').textContent = t.liveData;
                document.querySelector('[data-tab="ai-insights"] span').textContent = t.aiInsights;
                document.querySelector('[data-tab="map"] span').textContent = t.mapView;
                document.querySelector('[data-tab="grievances"] span').textContent = t.grievances;
                document.querySelector('[data-tab="contact"] span').textContent = t.contact;

                // Header
                const headerTitle = document.getElementById('header-title');
                if(headerTitle) headerTitle.textContent = t.overview;
                const welcomeMsg = document.querySelector('p.text-gray-500');
                if(welcomeMsg) welcomeMsg.textContent = t.welcomeMsg;

                // Stat cards
                const statLabels = [
                    document.querySelector('#total-households').previousElementSibling,
                    document.querySelector('#active-connections').previousElementSibling,
                    document.querySelector('#coverage').previousElementSibling,
                    document.querySelector('#active-alerts').previousElementSibling
                ];
                if(statLabels[0]) statLabels[0].textContent = t.totalHouseholds;
                if(statLabels[1]) statLabels[1].textContent = t.activeConnections;
                if(statLabels[2]) statLabels[2].textContent = t.coverage;
                if(statLabels[3]) statLabels[3].textContent = t.activeAlerts;

                // Buttons
                const summaryBtnSpan = document.getElementById('generate-summary-btn')?.querySelector('span');
                if(summaryBtnSpan) summaryBtnSpan.textContent = t.generateSummary;
                const forecastBtnSpan = document.getElementById('generate-forecast-btn')?.querySelector('span');
                if(forecastBtnSpan) forecastBtnSpan.textContent = t.predictiveMaintenance;
                const analyzeLogsBtnSpan = document.getElementById('analyze-logs-btn')?.querySelector('span');
                if(analyzeLogsBtnSpan) analyzeLogsBtnSpan.textContent = t.analyzeLogs;

                // Input placeholders
                const searchInput = document.getElementById('search-input');
                if(searchInput) searchInput.placeholder = t.searchPlaceholder;
                const logSearchInput = document.getElementById('log-search-input');
                if(logSearchInput) logSearchInput.placeholder = t.searchPlaceholder;
            }

            // Set default language on load
            setLanguage('en');

            // --- Accessibility: Focus Management for Sidebar ---
            function trapFocus(element) {
                const focusableEls = element.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])');
                const firstFocusableEl = focusableEls[0];
                const lastFocusableEl = focusableEls[focusableEls.length - 1];
                const KEYCODE_TAB = 9;

                element.addEventListener('keydown', function(e) {
                    const isTabPressed = (e.key === 'Tab' || e.keyCode === KEYCODE_TAB);
                    if (!isTabPressed) { return; }

                    if (e.shiftKey) { // if shift key pressed for shift + tab combination
                        if (document.activeElement === firstFocusableEl) {
                            lastFocusableEl.focus(); // move focus to the last focusable element
                            e.preventDefault();
                        }
                    } else { // if tab key is pressed
                        if (document.activeElement === lastFocusableEl) {
                            firstFocusableEl.focus(); // move focus to the first focusable element
                            e.preventDefault();
                        }
                    }
                });
            }

            // Trap focus in sidebar when it's open on mobile
            if (sidebar) {
                trapFocus(sidebar);
            }

            // Tab switching logic
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const tabContents = document.querySelectorAll('.tab-content');
            const headerTitle = document.getElementById('header-title');

            // --- Chart Section ---
            // Chart instances
            let waterChartInstance, chlorineChartInstance, fhtcChartInstance, smartMeterInterval, waterQualityTrendChart, riskTrendsChart, mapInstance, selectedVillageMarker = null;
            var assetLayerGroup;

            // Chart global configuration
            const chartFont = "'Plus Jakarta Sans', sans-serif";
            Chart.defaults.font.family = chartFont;
            Chart.defaults.plugins.legend.position = 'bottom';

    // Chart Initializers (always destroy previous instance before creating new)
    function setCanvasHeight(id, heightPx = 280) {
        const canvas = document.getElementById(id);
        if (canvas) {
            canvas.height = heightPx;
            canvas.style.height = heightPx + "px";
        }
    }

    function initWaterChart() {
        const ctx = document.getElementById('waterChart');
        if (!ctx) return;
        if (waterChartInstance) {
            waterChartInstance.destroy();
            waterChartInstance = null;
        }
        setCanvasHeight('waterChart');
        waterChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                datasets: [{
                    label: 'Supply (kL)',
                    data: [95, 98, 97, 99, 96, 98, 100],
                    backgroundColor: [
                        'rgba(59,130,246,0.85)',
                        'rgba(16,185,129,0.85)',
                        'rgba(249,115,22,0.85)',
                        'rgba(236,72,153,0.85)',
                        'rgba(139,92,246,0.85)',
                        'rgba(251,191,36,0.85)',
                        'rgba(6,182,212,0.85)'
                    ],
                    borderColor: [
                        'rgba(59,130,246,1)',
                        'rgba(16,185,129,1)',
                        'rgba(249,115,22,1)',
                        'rgba(236,72,153,1)',
                        'rgba(139,92,246,1)',
                        'rgba(251,191,36,1)',
                        'rgba(6,182,212,1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 12,
                    hoverBackgroundColor: [
                        'rgba(59,130,246,1)',
                        'rgba(16,185,129,1)',
                        'rgba(249,115,22,1)',
                        'rgba(236,72,153,1)',
                        'rgba(139,92,246,1)',
                        'rgba(251,191,36,1)',
                        'rgba(6,182,212,1)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true, grid: { drawBorder: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

            function initChlorineChart() {
                const ctx = document.getElementById('chlorineChart');
                if (!ctx) return;
                if (chlorineChartInstance) {
                    chlorineChartInstance.destroy();
                    chlorineChartInstance = null;
                }
                setCanvasHeight('chlorineChart');
                chlorineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                        datasets: [{
                            label: 'Chlorine (mg/L)',
                            data: [0.5, 0.4, 0.6, 0.5, 0.4, 0.5, 0.5],
                            borderColor: 'rgba(236,72,153,1)',
                            backgroundColor: 'rgba(236,72,153,0.15)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(236,72,153,1)',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: { y: { grid: { drawBorder: false } }, x: { grid: { display: false } } }
                    }
                });
            }

            function initFhtcChart() {
                const ctx = document.getElementById('fhtcChart');
                if (!ctx) return;
                if (fhtcChartInstance) {
                    fhtcChartInstance.destroy();
                    fhtcChartInstance = null;
                }
                setCanvasHeight('fhtcChart');
                fhtcChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["Jan", "Feb", "Mar", "Apr", "May"],
                        datasets: [{
                            label: 'Connections',
                            data: [1000, 1100, 1150, 1200, 1250],
                            borderColor: 'rgba(34,197,94,1)',
                            backgroundColor: 'rgba(34,197,94,0.15)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(34,197,94,1)',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: { y: { grid: { drawBorder: false } }, x: { grid: { display: false } } }
                    }
                });
            }

            function initRiskTrendsChart() {
                const ctx = document.getElementById('riskTrendsChart');
                if (!ctx) return;
                if (riskTrendsChart) {
                    riskTrendsChart.destroy();
                    riskTrendsChart = null;
                }
                const history = JSON.parse(localStorage.getItem('riskHistory') || '[]');
                const labels = history.length > 0 ? history.map(h => new Date(h.time).toLocaleDateString()) : ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                const data = history.length > 0 ? history.map(h => h.avgRisk) : [10, 15, 20, 25, 30, 35, 40];
                riskTrendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Risk Score',
                            data: data,
                            borderColor: 'rgba(168,85,247,1)',
                            backgroundColor: 'rgba(168,85,247,0.15)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(168,85,247,1)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: { y: { beginAtZero: true, grid: { drawBorder: false } }, x: { grid: { display: false } } }
                    }
                });
            }

            function initMap() {
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
                const mapContainer = document.getElementById('map-container');
                if (!mapContainer || mapContainer._leaflet_id) return;

                // Set initial view to the center of Dakshina Kannada district
                const initialCoords = [12.87, 75.04]; // Approximate center of Dakshina Kannada district

                mapInstance = L.map('map-container').setView(initialCoords, 12);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapInstance);

                assetLayerGroup = L.layerGroup().addTo(mapInstance);

                // Add markers for all villages
                for (const villageName in villageData) {
                    const village = villageData[villageName];
                    if (village.coordinates) {
                        let iconColorClass = 'green'; // default
                        const statusText = village.pumpStatus || 'Operational';

                        if (statusText.toLowerCase().includes('maintenance')) {
                            iconColorClass = 'red';
                        } else if (statusText.toLowerCase().includes('partial')) {
                            iconColorClass = 'yellow';
                        }

                        const customIcon = L.divIcon({
                            className: `custom-marker-base custom-marker-${iconColorClass}`,
                            html: `<i data-lucide="home" class="w-4 h-4"></i>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        });

                        const marker = L.marker(village.coordinates, { icon: customIcon }).addTo(mapInstance);
                        marker.bindPopup(`<b>${villageName}</b><br><small>Click to view dashboard</small>`);

                        // Add click event listener to the marker
                        marker.on('click', function() {
                            // Reset previous marker's style
                            if (selectedVillageMarker) {
                                selectedVillageMarker.getElement().classList.remove('selected-village-marker');
                            }

                            // Highlight the new marker
                            this.getElement().classList.add('selected-village-marker');
                            selectedVillageMarker = this;

                            // Find the parent panchayat for the clicked village
                            const panchayatName = Object.keys(panchayatVillages).find(p => panchayatVillages[p].includes(villageName));
                            if (panchayatName) {
                                panchayatSelector.value = panchayatName; // Update panchayat dropdown
                                populateVillages(panchayatName); // Repopulate village dropdown
                                villageSelector.value = villageName; // Select the clicked village
                                updateDashboardForVillage(villageName); // Update the dashboard
                                showToast(`Switched to ${villageName} dashboard.`, 'info');
                            }
                        });
                    }
                }

                // --- Realistic Pipeline Network ---
                // Define a main trunk line that runs through the district
                const mainTrunk = [
                    [13.1, 74.8], // North-West
                    [12.95, 75.0],
                    [12.8, 75.25],
                    [12.6, 75.4]  // South-East
                ];

                // Draw the main trunk
                L.polyline.antPath(mainTrunk, {
                    "delay": 600,
                    "dashArray": [20, 20],
                    weight: 7, // Thicker main line
                    "color": "#075985", // Darker blue for main trunk
                    "pulseColor": "#FFFFFF"
                }).addTo(mapInstance).bindPopup("<b>Main District Pipeline</b>");

                // Draw branch lines from each village to the nearest point on the trunk
                Object.values(villageData).forEach(village => {
                    if (!village.coordinates) return;

                    // Find the closest vertex on the trunk line (simple approach)
                    let closestTrunkPoint = mainTrunk.reduce((prev, curr) => {
                        const prevDist = L.latLng(village.coordinates).distanceTo(L.latLng(prev));
                        const currDist = L.latLng(village.coordinates).distanceTo(L.latLng(curr));
                        return prevDist < currDist ? prev : curr;
                    });

                    // Draw a thinner, faster-animated branch line
                    const branchLine = [village.coordinates, closestTrunkPoint];
                    L.polyline.antPath(branchLine, {
                        "delay": 400,
                        "dashArray": [5, 10],
                        weight: 5,
                        "color": "#0ea5e9" // Lighter blue for branches
                    }).addTo(mapInstance);
                });

                // Set initial view to fit all villages in the district
                const allVillageMarkers = Object.values(villageData)
                    .filter(v => v.coordinates)
                    .map(v => L.marker(v.coordinates));
                const allVillagesGroup = new L.featureGroup(allVillageMarkers);
                mapInstance.fitBounds(allVillagesGroup.getBounds().pad(0.1));

                // Initially, show assets for all villages
                addAssetsToMap();

                // Add Legend to the map
                const legend = L.control({position: 'bottomleft'});

                // Add event listeners for map filters
                document.querySelectorAll('.map-filter-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        addAssetsToMap(panchayatSelector.value);
                    });
                });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML += '<h4>Map Legend</h4>';
                    
                    const villageStatuses = {
                        'Operational': 'green',
                        'Partial Service': 'yellow',
                        'Needs Maintenance': 'red'
                    };
                    div.innerHTML += '<strong>Village Status</strong>';
                    for (const status in villageStatuses) {
                        div.innerHTML += `<div class="legend-item"><div class="custom-marker-base custom-marker-${villageStatuses[status]} legend-marker"><i data-lucide="home" class="w-4 h-4"></i></div> ${status}</div>`;
                    }

                    const assetTypes = {
                        'Pump': { color: 'red', icon: 'server' },
                        'Valve': { color: 'yellow', icon: 'toggle-right' },
                        'Filter': { color: 'blue', icon: 'filter' },
                        'Sensor': { color: 'green', icon: 'activity' }
                    };
                    div.innerHTML += '<br><strong>Assets</strong>';
                    for (const type in assetTypes) {
                        div.innerHTML += `<div class="legend-item"><div class="custom-marker-base custom-marker-${assetTypes[type].color} legend-marker"><i data-lucide="${assetTypes[type].icon}" class="w-4 h-4"></i></div> ${type}</div>`;
                    }

                    // Prevent map clicks when interacting with the legend
                    L.DomEvent.disableClickPropagation(div);
                    return div;
                };

                legend.addTo(mapInstance);
                // Render lucide icons in the legend
                lucide.createIcons();
            }

            function addAssetsToMap(panchayatName) {
                assetLayerGroup.clearLayers();
                const villagesInPanchayat = panchayatVillages[panchayatName] || [];
                const allMarkers = [];

                // If a panchayatName is provided, show assets for that panchayat.
                // Otherwise, show assets for all villages.
                const villagesToShow = panchayatName ? villagesInPanchayat : Object.keys(villageData);

                // Get the state of the filters
                const activeFilters = new Set();
                document.querySelectorAll('.map-filter-checkbox:checked').forEach(checkbox => {
                    activeFilters.add(checkbox.dataset.assetType);
                });


                villagesToShow.forEach(villageName => {
                  const village = villageData[villageName];
                  if (!village || !village.coordinates) return;

                  const addAsset = (asset, type, iconClass) => {
                      const offsetLat = (Math.random() - 0.5) * 0.001; // Small random offset
                      const offsetLng = (Math.random() - 0.5) * 0.001;
                      const assetCoords = asset.lat && asset.lng ? [asset.lat, asset.lng] : [village.coordinates[0] + offsetLat, village.coordinates[1] + offsetLng];

                      const icon = L.divIcon({
                          className: `custom-marker-base ${iconClass}`,
                          html: `<i data-lucide="${getIconForAsset(type)}" class="w-4 h-4"></i>`,
                          iconSize: [28, 28],
                          iconAnchor: [14, 14]
                      });
                      const marker = L.marker(assetCoords, { icon: icon }).addTo(assetLayerGroup);
                      
                      // --- Enhanced Popup Content ---
                      let popupContent = `<div class="text-sm">
                        <h4 class="font-bold text-base mb-1">${asset.name}</h4>
                        <p><strong>Type:</strong> ${type}</p>
                        <p><strong>Village:</strong> ${villageName}</p>`;

                      if (type === 'Pump') {
                          popupContent += `<p><strong>Status:</strong> ${asset.status}</p><p><strong>Hours:</strong> ${asset.runningHours}</p><p><strong>Last Maint:</strong> ${asset.lastMaintenance}</p>`;
                      } else if (type === 'Valve') {
                          popupContent += `<p><strong>Status:</strong> ${asset.status}</p><p><strong>Last Operated:</strong> ${asset.lastOperated}</p>`;
                      } else if (type === 'Filter') {
                          popupContent += `<p><strong>Status:</strong> ${asset.status}</p><p><strong>Last Cleaned:</strong> ${asset.lastCleaned}</p>`;
                      } else if (type === 'Sensor') {
                          popupContent += `<p><strong>Sensor Type:</strong> ${asset.type}</p><p><strong>Reading:</strong> ${asset.reading}</p>`;
                      }
                      
                      popupContent += `</div>`;
                      marker.bindPopup(popupContent);

                      allMarkers.push(marker);
                  };

                  if (village.pumps) {
                      if (activeFilters.has('Pump')) village.pumps.forEach(pump => addAsset(pump, 'Pump', 'custom-marker-red'));
                  }
                  if (village.valves) {
                      if (activeFilters.has('Valve')) village.valves.forEach(valve => addAsset(valve, 'Valve', 'custom-marker-yellow'));
                  }
                  if (village.filters) {
                      if (activeFilters.has('Filter')) village.filters.forEach(filter => addAsset(filter, 'Filter', 'custom-marker-blue'));
                  }
                  if (village.sensors) {
                      if (activeFilters.has('Sensor')) village.sensors.forEach(sensor => addAsset(sensor, 'Sensor', 'custom-marker-green'));
                  }
              });

                if (allMarkers.length > 0 && mapInstance) {
                    const group = new L.featureGroup(allMarkers);
                    mapInstance.fitBounds(group.getBounds().pad(0.1)); // .pad(0.1) adds 10% padding
                }

            }

            function getIconForAsset(type) {
                switch (type.toLowerCase()) {
                    case 'pump':
                        return 'server';
                    case 'valve':
                        return 'toggle-right';
                    case 'filter':
                        return 'filter';
                    case 'sensor':
                        return 'activity';
                    default:
                        return 'map-pin';
                }
            }
            // --- Real-Time Sensor Integration (Demo for MVP) ---
            let sensorCharts = {};
            // Daily routine check variables
            // Add a state for simulations
            let simulationState = 'normal'; // can be 'normal', 'leak', or 'pump_failure'

            let dailyPumpHours = 8.5;
            let valveCheckStatus = "OPEN";
            let leakDetectionStatus = "No Leaks Detected";
            let lastQualityTest = "Today 10:00 AM";

            function initSensorCharts() {
                const ctxFlow = document.getElementById('flowRateChart');
                const ctxPressure = document.getElementById('pressureChart');
                if (!ctxFlow || !ctxPressure) return;

                sensorCharts.flow = new Chart(ctxFlow, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 10}, (_, i) => `T-${10-i}s`),
                        datasets: [{
                            label: 'Flow Rate (L/min)',
                            data: Array(10).fill().map(()=>Math.random()*100+300),
            borderColor: 'rgba(37,99,235,1)',
            backgroundColor: 'rgba(37,99,235,0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: { responsive: true, maintainAspectRatio: true }
                });

                sensorCharts.pressure = new Chart(ctxPressure, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 10}, (_, i) => `T-${10-i}s`),
                        datasets: [{
                            label: 'Pressure (bar)',
                            data: Array(10).fill().map(()=>Math.random()*2+4),
            borderColor: 'rgba(16,185,129,1)',
            backgroundColor: 'rgba(16,185,129,0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            function updateSensorData() {
                const pump1StatusEl = document.getElementById('pump-p1-status');
                const pump2StatusEl = document.getElementById('pump-p2-status');
                const valve1StatusEl = document.getElementById('valve-v1-status');
                const valve2StatusEl = document.getElementById('valve-v2-status');
                const reservoirLevelDisplay = document.getElementById('reservoir-level-display');

                let pump1Status, pump2Status, valve1Status, valve2Status, reservoirLvl, flowRate, pressure;

                switch (simulationState) {
                    case 'leak':
                        pump1Status = "ON";
                        pump2Status = "ON"; // Pumps may work harder
                        valve1Status = "OPEN";
                        valve2Status = "OPEN";
                        reservoirLvl = Math.floor(50 + Math.random() * 20); // Level drops faster
                        flowRate = Math.random() * 50 + 400; // Flow rate might be higher
                        pressure = Math.random() * 1 + 2.5; // But pressure drops
                        break;
                    case 'pump_failure':
                        pump1Status = "OFF"; // One pump fails
                        pump2Status = "ON";
                        valve1Status = "OPEN";
                        valve2Status = "OPEN";
                        reservoirLvl = Math.floor(70 + Math.random() * 10);
                        flowRate = Math.random() * 50 + 150; // Flow rate drops significantly
                        pressure = Math.random() * 1 + 3.0; // Pressure drops
                        break;
                    default: // 'normal'
                        pump1Status = Math.random() > 0.2 ? "ON" : "OFF";
                        pump2Status = Math.random() > 0.15 ? "ON" : "OFF";
                        valve1Status = Math.random() > 0.3 ? "OPEN" : "CLOSED";
                        valve2Status = Math.random() > 0.25 ? "OPEN" : "CLOSED";
                        reservoirLvl = Math.floor(60 + Math.random() * 40);
                        flowRate = Math.random() * 100 + 300;
                        pressure = Math.random() * 2 + 4;
                        break;
                }

                if (pump1StatusEl) { pump1StatusEl.textContent = pump1Status; pump1StatusEl.className = `font-bold ${pump1Status === 'ON' ? 'text-green-600' : 'text-red-600'}`; }
                if (pump2StatusEl) { pump2StatusEl.textContent = pump2Status; pump2StatusEl.className = `font-bold ${pump2Status === 'ON' ? 'text-green-600' : 'text-red-600'}`; }
                if (valve1StatusEl) { valve1StatusEl.textContent = valve1Status; valve1StatusEl.className = `font-bold ${valve1Status === 'OPEN' ? 'text-green-600' : 'text-yellow-600'}`; }
                if (valve2StatusEl) { valve2StatusEl.textContent = valve2Status; valve2StatusEl.className = `font-bold ${valve2Status === 'OPEN' ? 'text-green-600' : 'text-yellow-600'}`; }
                if (reservoirLevelDisplay) { reservoirLevelDisplay.textContent = `${reservoirLvl}%`; }

                // Update overview tab as well
                const p1Overview = document.getElementById('pump-p1-status-overview');
                const p2Overview = document.getElementById('pump-p2-status-overview');
                const v1Overview = document.getElementById('valve-v1-status-overview');
                const v2Overview = document.getElementById('valve-v2-status-overview');

                if(p1Overview) { p1Overview.textContent = pump1Status === 'ON' ? 'Operational' : 'Offline'; p1Overview.className = `px-3 py-1 rounded-full text-sm font-semibold ${pump1Status === 'ON' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`; }
                if(p2Overview) { p2Overview.textContent = pump2Status === 'ON' ? 'Operational' : 'Offline'; p2Overview.className = `px-3 py-1 rounded-full text-sm font-semibold ${pump2Status === 'ON' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`; }
                if(v1Overview) { v1Overview.textContent = valve1Status; v1Overview.className = `px-3 py-1 rounded-full text-sm font-semibold ${valve1Status === 'OPEN' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`; }
                if(v2Overview) { v2Overview.textContent = valve2Status; v2Overview.className = `px-3 py-1 rounded-full text-sm font-semibold ${valve2Status === 'OPEN' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`; }

                // Update daily pump hours (simulate increment)
                if (pump1Status === "ON") {
                    dailyPumpHours += 0.1; // increment by 6 minutes per update (every 3s)
                }

                // Leak detection logic
                if (flowRate < 250 || pressure < 3.5 || (pump1Status === 'ON' && pump2Status === 'ON' && flowRate < 400)) {
                    leakDetectionStatus = "Leak Detected!";
                } else {
                    leakDetectionStatus = "No Leaks Detected";
                }

                // Update display
                document.getElementById('daily-pump-hours').textContent = dailyPumpHours.toFixed(1) + " hrs";
                document.getElementById('valve-check-status').textContent = valve1Status;
                document.getElementById('leak-detection-status').textContent = leakDetectionStatus;
                document.getElementById('leak-detection-status').className = leakDetectionStatus.includes("Detected") ? "font-bold text-red-600" : "font-bold text-green-600";
                document.getElementById('last-quality-test').textContent = lastQualityTest;

                Object.values(sensorCharts).forEach(chart => {
                    if (!chart || !chart.data || !chart.data.datasets[0]) return;
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[0].data.push(
                        chart.data.datasets[0].label.includes("Flow")
                          ? flowRate
                          : pressure
                    );
                    chart.update();
                });

                // Show alert if leak detected
                if (leakDetectionStatus.includes("Detected")) {
                    document.getElementById('check-alert').classList.remove('hidden');
                } else {
                    document.getElementById('check-alert').classList.add('hidden');
                }

                if (Math.random() < 0.2) {
                    const alertMsg = ["Pressure Drop Detected", "Valve Stuck", "Pump Overheat Warning"][Math.floor(Math.random()*3)];
                    const toast = document.createElement('div');
                    toast.textContent = alertMsg;
                    toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg animate-bounce';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            }

            setInterval(updateSensorData, 3000);
            // --- End Chart Section ---
            // Fix: Ensure at least one tab is visible on load
            function showDefaultTab() {
                // Remove 'active' from all tabs
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                // Find hash or default to overview
                let hash = window.location.hash.replace('#', '');
                let defaultTab = document.getElementById(hash) || document.getElementById('overview');
                if (defaultTab) defaultTab.classList.add('active');
            }
            showDefaultTab();

            // Update tab switching logic to always set 'active' class
            function switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                document.querySelectorAll('.sidebar-link').forEach(link => link.setAttribute('aria-selected', 'false'));

                const activeTab = document.getElementById(tabId);
                const activeLink = document.querySelector(`.sidebar-link[data-tab="${tabId}"]`);
                if (activeTab) activeTab.classList.add('active');
                if (activeLink) {
                    activeLink.setAttribute('aria-selected', 'true');
                    activeLink.classList.add('active');
                    headerTitle.textContent = activeLink.querySelector('span').textContent;
                }

                // Lazily load charts when their tab is visible
                switch (tabId) {
                    case 'overview':
                        initWaterChart();
                        break;
                    case 'live-data':
                        initChlorineChart();
                        initFhtcChart();
                        initSensorCharts();
                        break;
                    case 'ai-insights':
                        initRiskTrendsChart();
                        break;
                    case 'map':
                        initMap();
                        break;
                }
            }

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.dataset.tab;
                    window.location.hash = tabId;
                    switchTab(tabId);

                    // Auto-close sidebar on mobile after tab selection
                    if (window.innerWidth < 768 && sidebar?.classList.contains('show')) {
                        sidebar.classList.remove('show');
                        mobileMenuBtn.setAttribute('aria-expanded', 'false');
                    }
                });
            });

            // Check for hash on page load to show correct tab
            const currentHash = window.location.hash.substring(1);
            if (currentHash) {
                switchTab(currentHash);
            } else {
                // Set default tab
                switchTab('overview');
            }


            // Chart.js Configuration - This section is now moved and handled by the initializer functions
            // const chartFont = "'Plus Jakarta Sans', sans-serif";
            // Chart.defaults.font.family = chartFont;
            // Chart.defaults.plugins.legend.position = 'bottom';
            
            // Water Supply Chart - MOVED
            // new Chart(document.getElementById('waterChart'), { ... });

            // Chlorine Levels Chart - MOVED
            // new Chart(document.getElementById('chlorineChart'), { ... });

            // FHTC Growth Chart - MOVED
            // new Chart(document.getElementById('fhtcChart'), { ... });

            // --- Panchayat & Village Data ---
            // Updated structure: { PanchayatName: [village1, village2, ...], ... }
            const panchayatVillages = {
                "Belthangady Taluk": [
                    "Ujire", "Belthangady", "Kaniyoor", "Laila", "Kokkada", "Kalthodu"
                ],
                "Bantwal Taluk": [
                    "Sajipamooda", "Bantwal", "Panemangalore", "Kalladka", "Kinnigoli", "Bajjodi"
                ],
                "Puttur Taluk": [
                    "Aryapu", "Puttur", "Nettanige Mudnoor", "Ainekidu", "Koppa", "Kannikodi"
                ],
                "Sullia Taluk": [
                    "Sullia", "Aletty", "Aranthodu", "Bellare", "Kanive", "Nalkeri"
                ],
                "Mangaluru Taluk": [
                    "Mangaluru Rural", "Mulki", "Surathkal", "Bajpe", "Ullal", "Thokur"
                ]
            };

            // Optionally, you can map village data for AI/Charts per village
            let villageData = {
                "Ujire": {
                    supply: [95, 98, 97, 99, 96, 98, 100],
                    coordinates: [12.99, 75.33],
                    chlorine: [0.5, 0.4, 0.6, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1000, 1100, 1150, 1200, 1250],
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 2", status: "In Progress" },
                        { type: "Low Pressure", location: "Market", status: "Resolved" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 09:30 AM", level: "INFO", message: "FTK Test Passed at School Point" },
                        { timestamp: "2025-03-10 08:00 AM", level: "INFO", message: "Pump Maintenance Scheduled for UJ-P1" },
                        { timestamp: "2025-03-09 11:45 PM", level: "WARN", message: "Pressure drop detected in Zone B pipeline" }
                    ],
                    pumps: [
                        { lat: 12.991, lng: 75.331, name: "Pump P-1", status: "Operational", runningHours: 1250, lastMaintenance: "2025-02-15" },
                        { lat: 12.990, lng: 75.332, name: "Pump P-2", status: "Needs Maintenance", runningHours: 2500, lastMaintenance: "2024-11-20" }
                    ],
                    valves: [
                        { lat: 12.992, lng: 75.332, name: "Valve V-1", status: "Open", lastOperated: "2025-03-10 08:00" },
                        { lat: 12.993, lng: 75.333, name: "Valve V-2", status: "Closed", lastOperated: "2025-03-09 18:00" }
                    ],
                    filters: [
                        { lat: 12.993, lng: 75.333, name: "Filter Unit A", status: "Clean", lastCleaned: "2025-03-01" },
                        { lat: 12.994, lng: 75.334, name: "Filter Unit B", status: "Needs Cleaning", lastCleaned: "2025-01-15" }
                    ],
                    sensors: [
                        { lat: 12.995, lng: 75.335, name: "Flow Sensor 1", type: "Flow", reading: "450 L/min" },
                        { lat: 12.996, lng: 75.336, name: "Pressure Sensor 1", type: "Pressure", reading: "5.2 bar" }
                    ],
                    houses: [
                        { lat: 12.994, lng: 75.334, name: "House 1" },
                        { lat: 12.995, lng: 75.335, name: "House 2" },
                        { lat: 12.996, lng: 75.336, name: "House 3" }
                    ]
                },
                "Sajipamooda": {
                    supply: [60, 61, 62, 59, 63, 62, 62.5],
                    coordinates: [12.87, 74.96],
                    chlorine: [0.4, 0.4, 0.3, 0.3, 0.2, 0.3, 0.3],
                    fhtc: [600, 650, 700, 750, 780],
                    pumpRunningHours: 600,
                    filterLastCleanedDate: '2024-07-01',
                    grievances: [
                        { type: "Contaminated Water", location: "Ward 1", status: "Pending" }
                    ],
    logs: [
        { timestamp: "2025-03-10 11:15 AM", level: "ERROR", message: "Low chlorine detected at source SM-BW-01" },
        { timestamp: "2025-03-09 04:00 PM", level: "INFO", message: "Water sample sent to Taluk lab" }
    ],
    pumps: [{ lat: 12.871, lng: 74.961, name: "Pump P-2" }],
    valves: [{ lat: 12.872, lng: 74.962, name: "Valve V-2" }],
    filters: [{ lat: 12.873, lng: 74.963, name: "Filter Unit B" }],
    houses: [
        { lat: 12.874, lng: 74.964, name: "House 4" },
        { lat: 12.875, lng: 74.965, name: "House 5" }
    ]
},
                "Aryapu": {
                    supply: [72, 75, 74, 76, 75, 73, 75],
                    coordinates: [12.78, 75.25],
                    chlorine: [0.5, 0.5, 0.4, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [800, 850, 900, 920, 945],
                    pumpRunningHours: 450,
                    filterLastCleanedDate: '2024-07-10',
                    grievances: [],
    logs: [
        { timestamp: "2025-03-10 01:30 PM", level: "INFO", message: "5 new FHTC connections approved" },
        { timestamp: "2025-03-10 10:00 AM", level: "WARN", message: "Pipeline repair underway in Ward 3" }
    ],
    pumps: [{ lat: 12.781, lng: 75.251, name: "Pump P-3" }],
    valves: [{ lat: 12.782, lng: 75.252, name: "Valve V-3" }],
    filters: [{ lat: 12.783, lng: 75.253, name: "Filter Unit C" }],
    houses: [
        { lat: 12.784, lng: 75.254, name: "House 6" },
        { lat: 12.785, lng: 75.255, name: "House 7" }
    ]
},
                "Belthangady": {
                    supply: [80, 81, 79, 82, 80, 81, 80.5],
                    coordinates: [13.0, 75.3],
                    chlorine: [0.4, 0.3, 0.3, 0.4, 0.3, 0.4, 0.35],
                    fhtc: [1200, 1300, 1350, 1400, 1450],
                    pumpRunningHours: 820,
                    filterLastCleanedDate: '2024-06-20',
                    grievances: [
                        { type: "No Water Supply", location: "Zone B", status: "In Progress" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 02:00 PM", level: "ERROR", message: "Low chlorine detected at BL-TW-01" }
                    ]
                },
                "Bantwal": {
                    supply: [70, 71, 70, 72, 69, 70, 70.2],
                    coordinates: [12.9, 75.04],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.45],
                    fhtc: [1100, 1150, 1200, 1250, 1300],
                    pumpRunningHours: 300,
                    filterLastCleanedDate: '2024-07-25',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-10 03:00 PM", level: "INFO", message: "Routine inspection completed" }
                    ]
                },
                "Puttur": {
                    supply: [82, 84, 85, 83, 85, 86, 85],
                    coordinates: [12.76, 75.21],
                    chlorine: [0.4, 0.4, 0.3, 0.4, 0.4, 0.3, 0.38],
                    fhtc: [1100, 1200, 1250, 1300, 1350],
                    pumpRunningHours: 550,
                    filterLastCleanedDate: '2024-07-05',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 5", status: "Resolved" }
                    ],
                    logs: [
                        { timestamp: "2025-03-09 09:00 AM", level: "WARN", message: "Pipeline repair in progress in Ward 5" }
                    ]
                },
                "Sullia": {
                    supply: [60, 58, 59, 61, 60, 62, 60],
                    coordinates: [12.56, 75.39],
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.3, 0.4, 0.32],
                    fhtc: [700, 750, 800, 820, 850],
                    pumpRunningHours: 710,
                    filterLastCleanedDate: '2024-07-01',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-08 10:00 AM", level: "WARN", message: "Low pH recorded in water test" }
                    ]
                },
                "Mangaluru Rural": {
                    supply: [118, 119, 120, 121, 119, 120, 120],
                    coordinates: [12.91, 74.85],
                    chlorine: [0.5, 0.5, 0.5, 0.6, 0.5, 0.5, 0.5],
                    fhtc: [1800, 1850, 1900, 1950, 1980],
                    pumpRunningHours: 250,
                    filterLastCleanedDate: '2024-07-28',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-10 11:00 AM", level: "INFO", message: "FTK test passed at Community Hall" }
                    ]
                },
                "Mulki": {
                    supply: [65, 64, 66, 65, 64, 65, 65],
                    coordinates: [13.1, 74.79],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.42],
                    fhtc: [900, 950, 1000, 1050, 1100],
                    pumpRunningHours: 150,
                    filterLastCleanedDate: '2024-07-20',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-09 02:00 PM", level: "INFO", message: "Routine pump maintenance done" }
                    ]
                },
                "Surathkal": {
                    supply: [98, 99, 100, 101, 99, 100, 100],
                    coordinates: [12.98, 74.80],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.5, 0.5, 0.48],
                    fhtc: [1400, 1450, 1500, 1550, 1600],
                    pumpRunningHours: 400,
                    filterLastCleanedDate: '2024-07-15',
                    grievances: [
                        { type: "Low Water Pressure", location: "Beach Road", status: "Resolved" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 01:00 PM", level: "INFO", message: "All systems verified operational" }
                    ]
                },
                "Kaniyoor": {
                    supply: [70, 72, 71, 73, 74, 72, 71],
                    coordinates: [12.82, 75.40], // Approx
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [800, 850, 900, 950, 1000],
                    pumpRunningHours: 900,
                    filterLastCleanedDate: '2024-06-10',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 1", status: "Pending" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 08:30 AM", level: "ERROR", message: "Leak detected at main line" }
                    ]
                },
                "Laila": {
                    supply: [60, 62, 61, 63, 64, 62, 61],
                    coordinates: [13.01, 75.35], // Approx
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 350,
                    filterLastCleanedDate: '2024-07-18',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-11 09:00 AM", level: "INFO", message: "Water quality test scheduled" }
                    ]
                },
                "Panemangalore": {
                    supply: [80, 81, 82, 83, 82, 81, 80],
                    coordinates: [12.88, 75.01], // Approx
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1200, 1250, 1300, 1350, 1400],
                    pumpRunningHours: 680,
                    filterLastCleanedDate: '2024-07-02',
                    grievances: [
                        { type: "No Water Supply", location: "Ward 3", status: "In Progress" }
                    ],
                    logs: [
                        { timestamp: "2025-03-11 10:00 AM", level: "INFO", message: "Pump maintenance scheduled" }
                    ]
                },
                "Kalladka": {
                    supply: [75, 76, 77, 78, 77, 76, 75],
                    coordinates: [12.85, 75.01], // Approx
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [1000, 1050, 1100, 1150, 1200],
                    pumpRunningHours: 200,
                    filterLastCleanedDate: '2024-07-22',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-10 04:00 PM", level: "INFO", message: "Routine inspection completed" }
                    ]
                },
                "Nettanige Mudnoor": {
                    supply: [65, 66, 67, 68, 67, 66, 65],
                    coordinates: [12.68, 75.28], // Approx
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [900, 950, 1000, 1050, 1100],
                    pumpRunningHours: 730,
                    filterLastCleanedDate: '2024-06-30',
                    grievances: [
                        { type: "Contaminated Water", location: "Ward 2", status: "Pending" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 05:00 PM", level: "WARN", message: "Water sample sent to lab" }
                    ]
                },
                "Ainekidu": {
                    supply: [60, 61, 62, 63, 62, 61, 60],
                    coordinates: [12.70, 75.30], // Approx
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [800, 850, 900, 950, 1000],
                    pumpRunningHours: 100,
                    filterLastCleanedDate: '2024-07-29',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-10 06:00 PM", level: "INFO", message: "All systems normal" }
                    ]
                },
                "Aletty": {
                    supply: [55, 56, 57, 58, 57, 56, 55],
                    coordinates: [12.58, 75.45], // Approx
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 500,
                    filterLastCleanedDate: '2024-07-12',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 4", status: "In Progress" }
                    ],
                    logs: [
                        { timestamp: "2025-03-10 07:00 PM", level: "ERROR", message: "Leak detected at Ward 4" }
                    ]
                },
                "Aranthodu": {
                    supply: [50, 51, 52, 53, 52, 51, 50],
                    coordinates: [12.54, 75.43], // Approx
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [600, 650, 700, 750, 800],
                    pumpRunningHours: 650,
                    filterLastCleanedDate: '2024-07-08',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-09 08:00 AM", level: "INFO", message: "Pump maintenance completed" }
                    ]
                },
                "Bajpe": {
                    supply: [90, 91, 92, 93, 92, 91, 90],
                    coordinates: [12.98, 74.88], // Approx
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1500, 1550, 1600, 1650, 1700],
                    pumpRunningHours: 320,
                    filterLastCleanedDate: '2024-07-26',
                    grievances: [
                        { type: "Low Pressure", location: "Sector 1", status: "Resolved" }
                    ],
                    logs: [
                        { timestamp: "2025-03-09 09:00 PM", level: "INFO", message: "Pressure restored in Sector 1" }
                    ]
                },
                "Bellare": {
                    supply: [58, 59, 57, 60, 59, 58, 59],
                    coordinates: [12.53, 75.44],
                    chlorine: [0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 500,
                    filterLastCleanedDate: '2024-07-05',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-09 10:00 AM", level: "INFO", message: "Pump maintenance completed" }
                    ]
                },
                "Kanive": {
                    supply: [62, 63, 64, 62, 63, 62, 63],
                    coordinates: [12.52, 75.42],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.5, 0.4, 0.5],
                    fhtc: [750, 800, 850, 900, 950],
                    pumpRunningHours: 450,
                    filterLastCleanedDate: '2024-07-02',
                    grievances: [
                        { type: "Low Pressure", location: "Ward 1", status: "Pending" }
                    ],
                    logs: [
                        { timestamp: "2025-03-09 11:00 AM", level: "WARN", message: "Pressure drop detected" }
                    ]
                },
                "Nalkeri": {
                    supply: [55, 56, 55, 57, 56, 55, 56],
                    coordinates: [12.51, 75.41],
                    chlorine: [0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4],
                    fhtc: [600, 650, 700, 750, 800],
                    pumpRunningHours: 400,
                    filterLastCleanedDate: '2024-06-30',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-08 08:00 AM", level: "INFO", message: "Water quality normal" }
                    ]
                },
                "Kalthodu": {
                    supply: [55, 56, 57, 58, 57, 56, 55],
                    coordinates: [13.03, 75.38],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 500,
                    filterLastCleanedDate: '2024-07-12',
                    grievances: [],
                    logs: [
                        { timestamp: "2025-03-08 08:00 AM", level: "INFO", message: "Water quality normal" }
                    ]
                }
            };

            // --- Demo sensor and pump data for dashboard ---
            // Add demo sensor/pump fields if not already present
            Object.values(villageData).forEach(function(v) {
                if (!('pumpStatus' in v)) {
                    v.pumpStatus = Math.random() > 0.2 ? "Operational" : "Needs Maintenance";
                }
                if (!('pumpRunningHours' in v)) {
                    v.pumpRunningHours = Math.floor(200 + Math.random() * 800);
                }
                if (!('valvePosition' in v)) {
                    v.valvePosition = Math.random() > 0.3 ? "OPEN" : "CLOSED";
                }
                if (!('reservoirLevel' in v)) {
                    v.reservoirLevel = Math.floor(60 + Math.random() * 40);
                }
                if (!('flowRate' in v)) {
                    v.flowRate = Array.from({length: 10}, () => Math.random() * 100 + 300);
                }
                if (!('pressure' in v)) {
                    v.pressure = Array.from({length: 10}, () => Math.random() * 2 + 4);
                }
                if (!('microbiological' in v)) {
                    v.microbiological = ["Not Detected", "E. coli Detected", "Coliform Detected"][Math.floor(Math.random()*3)];
                }
                if (!('fluoride' in v)) {
                    v.fluoride = (Math.random()*3).toFixed(1);
                }
                if (!('lead' in v)) {
                    v.lead = (Math.random()*20).toFixed(1);
                }
                if (!('arsenic' in v)) {
                    v.arsenic = (Math.random()*20).toFixed(1);
                }
                if (!('turbidity' in v)) {
                    v.turbidity = (Math.random()*10).toFixed(1);
                }
                if (!('ph' in v)) {
                    v.ph = (5 + Math.random()*4).toFixed(2);
                }
                if (!('sensors' in v)) {
                    v.sensors = [{ lat: v.coordinates[0] + 0.001, lng: v.coordinates[1] + 0.001, name: "Flow Sensor" }];
                }
            });

            // Populate Panchayat selector
            const panchayatSelector = document.getElementById('panchayat-selector');
            const villageSelector = document.getElementById('village-selector');
            function populatePanchayats() {
                panchayatSelector.innerHTML = '';
                Object.keys(panchayatVillages).forEach(panchayat => {
                    const opt = document.createElement('option');
                    opt.value = panchayat;
                    opt.textContent = panchayat;
                    panchayatSelector.appendChild(opt);
                });
            }
            function populateVillages(panchayat) {
                villageSelector.innerHTML = '';
                (panchayatVillages[panchayat] || []).forEach(village => {
                    const opt = document.createElement('option');
                    opt.value = village;
                    opt.textContent = village;
                    villageSelector.appendChild(opt);
                });
            }
            // On change, update villages
            panchayatSelector?.addEventListener('change', function() {
                populateVillages(this.value);
                // After changing panchayat, update data for first village in the list
                updateDashboardForPanchayat(this.value);
            });
            // On village change, update data for AI/charts if needed
            villageSelector?.addEventListener('change', function() {
                const villageName = this.value;
                if (villageName) {
                    updateDashboardForVillage(villageName);

                    // Zoom map to selected village
                    const selectedVillageData = villageData[villageName];
                    if (mapInstance && selectedVillageData && selectedVillageData.coordinates) {
                        mapInstance.setView(selectedVillageData.coordinates, 14, { animate: true, duration: 1 }); // Zoom level 14 for a closer view
                    }
                }
            });
            // Initial population
            populatePanchayats();
            populateVillages(panchayatSelector.value);
            // Show data for the first panchayat on load
            updateDashboardForPanchayat(panchayatSelector.value);

            // --- Update Dashboard UI for selected village ---
            function updateDashboardForPanchayat(panchayatName) {
                // For now, we'll update the dashboard based on the first village of the panchayat
                const villages = panchayatVillages[panchayatName];
                if (villages && villages.length > 0) {
                    const firstVillage = villages[0];
                    villageSelector.value = firstVillage;
                    updateDashboardForVillage(firstVillage);

                    // Update assets on the map to show only for the selected panchayat
                    addAssetsToMap(panchayatName);

                    if (mapInstance) {
                        // Collect coordinates of all villages in the panchayat
                        const villageCoords = villages.map(villageName => villageData[villageName]?.coordinates).filter(coords => coords);

                        if (villageCoords.length > 0) {
                            // Create a feature group to calculate bounds
                            const villageMarkers = villageCoords.map(coords => L.marker(coords));
                            const group = new L.featureGroup(villageMarkers);
                            
                            // Fit the map to the bounds of all villages
                            mapInstance.fitBounds(group.getBounds().pad(0.2), { animate: true, duration: 1 });
                        } else {
                            // Fallback to the first village if no coordinates are found
                            const firstVillageData = villageData[firstVillage];
                            if (firstVillageData && firstVillageData.coordinates) {
                                mapInstance.setView(firstVillageData.coordinates, 14, { animate: true, duration: 1 });
                            }
                        }
                    }
                }
            }
            function updateDashboardForVillage(village) {
                const data = villageData[village] || { supply: [95, 98, 97, 99, 96, 98, 100], chlorine: [0.5, 0.4, 0.6, 0.5, 0.4, 0.5, 0.5], fhtc: [1000, 1100, 1150, 1200, 1250], grievances: [], logs: [] };
                // Update main chart (overview)
                if (waterChartInstance) { waterChartInstance.destroy(); waterChartInstance = null; }
                setCanvasHeight('waterChart');
                waterChartInstance = new Chart(document.getElementById('waterChart'), {
                    type: 'bar',
                    data: {
                        labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                        datasets: [{
                            label: 'Supply (kL)',
                            data: data.supply,
                            backgroundColor: [
                                'rgba(59,130,246,0.85)',
                                'rgba(16,185,129,0.85)',
                                'rgba(249,115,22,0.85)',
                                'rgba(236,72,153,0.85)',
                                'rgba(139,92,246,0.85)',
                                'rgba(251,191,36,0.85)',
                                'rgba(6,182,212,0.85)'
                            ],
                            borderColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 12,
                            hoverBackgroundColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
                // Update stat cards
                const totalHouseholds = data.fhtc && data.fhtc.length > 0 ? data.fhtc[data.fhtc.length - 1] : 0;
                document.getElementById('total-households').textContent = totalHouseholds;
                document.getElementById('active-connections').textContent = totalHouseholds;
                // Coverage: percent of days with supply >= 90 (arbitrary threshold for "coverage")
                let coveragePercent = '0%';
                if (data.supply && data.supply.length > 0) {
                    const coveredDays = data.supply.filter(v => v >= 90).length;
                    coveragePercent = Math.round((coveredDays / data.supply.length) * 100) + '%';
                }
                document.getElementById('coverage').textContent = coveragePercent;
                document.getElementById('active-alerts').textContent = data.grievances ? data.grievances.length : 0;

                // Update Grievance Tracker
                const grievanceTracker = document.getElementById('grievance-tracker');
                if (grievanceTracker) {
                    const grievances = data.grievances || [];
                    if (grievances.length === 0) {
                        grievanceTracker.innerHTML = `<p class="text-center text-gray-500">No active grievances for this village.</p>`;
                    } else {
                        grievanceTracker.innerHTML = grievances.map((g, index) => {
                            let statusColor, icon;
                            switch (g.status) {
                                case 'Resolved':
                                    statusColor = 'bg-green-100 text-green-800';
                                    icon = 'check-circle';
                                    break;
                                case 'In Progress':
                                    statusColor = 'bg-yellow-100 text-yellow-800';
                                    icon = 'wrench';
                                    break;
                                default: // New, Pending
                                    statusColor = 'bg-red-100 text-red-800';
                                    icon = 'shield-alert';
                            }
                            return `
                                <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg" data-grievance-id="${index}">
                                    <div class="${statusColor.split(' ')[0]} ${statusColor.split(' ')[1].replace('text-', 'bg-').replace('800', '-600')} p-2 rounded-full mt-1">
                                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold">${g.type} at ${g.location}</p>
                                        <p class="text-sm text-gray-500">Status: 
                                            <span class="grievance-status px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${g.status}</span>
                                        </p>
                                        <select class="grievance-status-select mt-2 border rounded px-2 py-1 text-sm">
                                            <option value="Pending" ${g.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="In Progress" ${g.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Resolved" ${g.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                        </select>
                                        <p class="text-xs text-gray-400">Reported ${g.date || 'recently'}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        // Add event listeners for the newly created status dropdowns
                        const statusSelects = grievanceTracker.querySelectorAll('.grievance-status-select');
                        statusSelects.forEach(select => {
                            select.addEventListener('change', function() {
                                const grievanceId = parseInt(this.closest('[data-grievance-id]').dataset.grievanceId, 10);
                                const newStatus = this.value;
                                const villageName = villageSelector.value;

                                // Update the data model
                                if (villageData[villageName] && villageData[villageName].grievances[grievanceId]) {
                                    villageData[villageName].grievances[grievanceId].status = newStatus;
                                    
                                    // Re-render the dashboard to reflect the change
                                    updateDashboardForVillage(villageName);
                                    
                                    showToast(`Grievance status updated to "${newStatus}".`, 'success');
                                }
                            });
                        });
                    }
                }

                // Update Logs List
                const logsList = document.getElementById('logs-list');
                if (logsList) {
                    let logs = data.logs || [];
                    const activeFilter = document.querySelector('.log-filter-btn.active-filter')?.dataset.level || 'All';
                    const searchTerm = document.getElementById('log-search-input')?.value.toLowerCase() || '';
                    
                    let filteredLogs = logs.filter(log => (activeFilter === 'All' || log.level === activeFilter) && (log.message.toLowerCase().includes(searchTerm) || log.timestamp.toLowerCase().includes(searchTerm)));
                    
                    if (filteredLogs.length === 0) {
                        logsList.innerHTML = `<li class="text-center text-gray-500 py-4">No logs match the current filter.</li>`;
                    } else {
                        logsList.innerHTML = filteredLogs.map(log => {
                            const levelMap = {
                                "INFO": { icon: "info", color: "blue" },
                                "WARN": { icon: "alert-triangle", color: "yellow" },
                                "ERROR": { icon: "shield-alert", color: "red" }
                            };
                            const logInfo = levelMap[log.level] || { icon: "file-text", color: "gray" };
                            
                            return `
                                <li class="log-item flex items-start space-x-3 text-sm p-3 bg-gray-50 rounded-lg border-l-4 border-${logInfo.color}-400">
                                    <i data-lucide="${logInfo.icon}" class="w-5 h-5 text-${logInfo.color}-500 mt-0.5 shrink-0"></i>
                                    <div class="flex-grow">
                                        <p class="font-medium text-gray-800">${log.message}</p>
                                        <p class="text-xs text-gray-500">${log.timestamp}</p>
                                    </div>
                                </li>`;
                        }).join('');
                    }
                }

                // Generate and display predictive alerts
                const predictiveAlerts = generatePredictiveAlerts(data);
                displayPredictiveAlerts(predictiveAlerts);
                // --- Dynamic generation of Households Table for Households Tab ---
                // Find the households table body
                const householdsTab = document.getElementById('households');
                if (householdsTab) {
                    const tableBody = document.getElementById('households-table-body');
                    if (tableBody) {
                        // Generate dummy households based on totalHouseholds (limit to 20 for demo)
                        let numHouseholds = Math.min(20, totalHouseholds || 10);
                        // For demo, generate randomized data per household
                        let rowsHtml = '';
                        for (let i = 1; i <= numHouseholds; i++) {
                            const houseId = (village ? village.substring(0,2).toUpperCase() : "XX") + "-H" + String(i).padStart(3,'0');
                            // Random weekly usage and average daily need
                            const weeklyUsage = Math.floor(90 + Math.random() * 80); // 90-170L
                            const avgDailyNeed = Math.floor(110 + Math.random() * 40); // 110-150L
                            rowsHtml += `
                                <tr class="border-b hover:bg-gray-50" data-usage="${weeklyUsage}" data-need="${avgDailyNeed}">
                                    <td class="p-4 text-gray-800 font-medium">${houseId}</td>
                                    <td class="p-4 text-gray-600">${weeklyUsage} L</td>
                                    <td class="p-4 text-gray-600">${avgDailyNeed} L</td>
                                    <td class="p-4">
                                        <button class="text-blue-600 hover:underline" onclick="openHouseholdModal('${houseId}')">Details</button>
                                    </td>
                                </tr>
                            `;
                        }
                        tableBody.innerHTML = rowsHtml;
                        lucide.createIcons();
                    }
                }

                // Update water quality chart if subtab is active
                if (!document.getElementById('water-quality').classList.contains('hidden')) {
                    initWaterQualityTrendChart();
                }

                // Update sensor charts if subtab is active
                if (!document.getElementById('live-data').classList.contains('hidden')) {
                    initSensorCharts();
                }
            }

            // For AI: use selected village's data if available
            function getCurrentVillageData() {
                return villageData[villageSelector.value] || villageData["Ujire"];
            }

            // --- Enhanced Predictive Maintenance Engine ---
            function generatePredictiveAlerts(data = {}) {
                const alerts = [];
                const now = new Date();
                const villageName = villageSelector.value;

                // Helper to add alerts
                const addAlert = (component, type, risk, reason, predictedIssue, scheduleDays) => {
                    const confidence = Math.round(60 + Math.random() * 40);
                    let priority = "Low";
                    if (risk > 70) priority = "High";
                    else if (risk > 40) priority = "Medium";

                    const nextDate = new Date(now.getTime() + scheduleDays * 24 * 60 * 60 * 1000);
                    const nextService = nextDate.toISOString().split('T')[0];

                    alerts.push({
                        component: component.name,
                        type: type,
                        location: villageName,
                        predictedIssue: predictedIssue,
                        risk: Math.round(risk),
                        confidence: confidence,
                        reason: reason,
                        action: priority === "High" ? "Immediate inspection required" : "Monitor and schedule maintenance",
                        schedule: nextService,
                        priority: priority
                    });
                };

                // Analyze Pumps
                (data.pumps || []).forEach(pump => {
                    let risk = 10;
                    let reason = "Pump operating within normal parameters.";
                    let predictedIssue = "Routine Check";
                    let scheduleDays = 30;

                    const hours = pump.runningHours || data.pumpRunningHours || Math.random() * 1000;
                    risk += (hours / 1000) * 40; // Risk increases with usage

                    if (hours > 900) {
                        risk += 30;
                        reason = `High running hours (${hours.toFixed(0)} hrs). Nearing end of service cycle.`;
                        predictedIssue = "Motor & Bearing Wear";
                        scheduleDays = 3;
                    } else if (hours > 600) {
                        risk += 15;
                        reason = `Moderate running hours (${hours.toFixed(0)} hrs).`;
                        predictedIssue = "Efficiency Check";
                        scheduleDays = 14;
                    }
                    addAlert(pump, "Pump", risk, reason, predictedIssue, scheduleDays);
                });

                // Analyze Filters
                (data.filters || []).forEach(filter => {
                    let risk = 5;
                    let reason = "Filter appears clean and functional.";
                    let predictedIssue = "Routine Check";
                    let scheduleDays = 45;

                    const lastCleaned = new Date(filter.lastCleanedDate || data.filterLastCleanedDate || '2024-07-01');
                    const daysSinceCleaned = (now - lastCleaned) / (1000 * 60 * 60 * 24);
                    risk += (daysSinceCleaned / 30) * 50; // Risk increases over time

                    if (daysSinceCleaned > 25) {
                        risk += 40;
                        reason = `Filter not cleaned for ${daysSinceCleaned.toFixed(0)} days. High risk of clogging.`;
                        predictedIssue = "Clogging/Biofouling";
                        scheduleDays = 2;
                    } else if (daysSinceCleaned > 15) {
                        risk += 20;
                        reason = `Filter last cleaned ${daysSinceCleaned.toFixed(0)} days ago.`;
                        predictedIssue = "Pressure Drop";
                        scheduleDays = 10;
                    }
                    addAlert(filter, "Filter", risk, reason, predictedIssue, scheduleDays);
                });

                // Analyze Valves
                (data.valves || []).forEach(valve => {
                    let risk = 5 + Math.random() * 20; // Base random risk for valves
                    let reason = "Valve operating normally.";
                    let predictedIssue = "Routine Check";
                    let scheduleDays = 60;

                    if (risk > 20) {
                        reason = "Simulated pressure drop detected near valve location.";
                        predictedIssue = "Potential Leak/Stuck";
                        scheduleDays = 7;
                    }
                    addAlert(valve, "Valve", risk, reason, predictedIssue, scheduleDays);
                });

                return alerts.sort((a, b) => b.risk - a.risk); // Sort by highest risk
            }

            function updateRiskSummary(alerts){
              const high = alerts.filter(a=>a.priority==="High").length;
              const medium = alerts.filter(a=>a.priority==="Medium").length;
              const low = alerts.filter(a=>a.priority==="Low").length;
              const total = alerts.length;
              const healthy = low;
              const avgRisk = alerts.length > 0 ? Math.round(alerts.reduce((sum, a) => sum + a.risk, 0) / alerts.length) : 0;
              document.getElementById("highRiskCount").innerText = high;
              document.getElementById("upcomingMaintCount").innerText = medium;
              document.getElementById("healthyCount").innerText = healthy;
              document.getElementById("totalComponents").innerText = total;
              document.getElementById("avgRiskScore").innerText = avgRisk;
            }

            function predictMaintenance(){
              const alerts = generatePredictiveAlerts();
              displayPredictiveAlerts(alerts);
              updateRiskSummary(alerts);
              const avgRisk = alerts.length > 0 ? Math.round(alerts.reduce((sum, a) => sum + a.risk, 0) / alerts.length) : 0;
              const maintenanceHistory = JSON.parse(localStorage.getItem('maintenanceHistory')||"[]");
              maintenanceHistory.push({time: Date.now(), alerts});
              if (maintenanceHistory.length>25) maintenanceHistory.shift();
              localStorage.setItem('maintenanceHistory', JSON.stringify(maintenanceHistory));
              const riskHistory = JSON.parse(localStorage.getItem('riskHistory')||"[]");
              riskHistory.push({time: Date.now(), avgRisk});
              if (riskHistory.length>7) riskHistory.shift();
              localStorage.setItem('riskHistory', JSON.stringify(riskHistory));
              // Update risk trends chart if exists
              if (riskTrendsChart) {
                riskTrendsChart.data.labels = riskHistory.map(h => new Date(h.time).toLocaleDateString());
                riskTrendsChart.data.datasets[0].data = riskHistory.map(h => h.avgRisk);
                riskTrendsChart.update();
              }
            }

            setInterval(predictMaintenance,10000);
            window.addEventListener("load", predictMaintenance);


            // --- GEMINI API INTEGRATION ---
            const apiKey = "AIzaSyBdNkotzhmT4NEKVqHi8FsriAbOpbIMLBo"; // WARNING: Do not expose API keys in client-side code in production. Use a backend proxy.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // --- Maintenance Reports Section ---
            function generateReports(village) {
                const data = villageData[village] || {};
                const reportsContainer = document.getElementById("reports-container");
                reportsContainer.innerHTML = `
                    <h4 class="font-bold text-blue-600">Pump Report</h4>
                    <p>Running Hours: ${data.pumpRunningHours || 0} hrs</p>
                    <p>Status: ${Math.random() > 0.2 ? "Operational" : "Needs Maintenance"}</p>
                    
                    <h4 class="font-bold text-blue-600 mt-4">Pipe Report</h4>
                    <p>Leakages detected: ${Math.random() > 0.7 ? "Yes" : "No"}</p>
                    <p>Pressure deviation: ${Math.floor(Math.random()*10)}%</p>
                    
                    <h4 class="font-bold text-blue-600 mt-4">Filter Report</h4>
                    <p>Last cleaned: ${data.filterLastCleanedDate || "N/A"}</p>
                    <p>Clog risk: ${Math.random() > 0.8 ? "High" : "Low"}</p>
                    
                    <h4 class="font-bold text-blue-600 mt-4">Sensor Summary</h4>
                    <p>Flow Rate: ${Math.floor(Math.random()*100 + 300)} L/min</p>
                    <p>Pressure: ${Math.floor(Math.random()*2 + 4)} bar</p>
                `;
            }

            // Extend existing updateDashboardForVillage to call generateReports
            const originalUpdateDashboardForVillage = updateDashboardForVillage;
            updateDashboardForVillage = function(village) {
                originalUpdateDashboardForVillage(village);
                generateReports(village);
            };

            // --- FAQ Section Logic ---
            const faqs = [
                { q: "How do I switch between villages?", a: "Use the 'Select Panchayat' and 'Select Village' dropdown menus at the top of the 'Overview' tab. The entire dashboard will update with the data for the selected village." },
                { q: "What does the 'AI Insights' tab do?", a: "The AI Insights tab uses Gemini AI to analyze your village's data. It can generate a weekly summary of activities and provide a predictive maintenance forecast to help you prevent issues before they happen." },
                { q: "How is the 'Risk Score' calculated?", a: "The risk score is calculated based on several factors, including the component's age, running hours, time since last maintenance, and any recent anomalies detected in sensor data (like pressure drops or temperature spikes)." },
                { q: "Can I see details for a specific house?", a: "Yes. Go to the 'Households' tab. Each household in the list is clickable. Clicking on one will open a modal with a detailed weekly usage chart for that specific house." },
                { q: "How often is the 'Live Data' updated?", a: "The live sensor data is simulated to update every 3 seconds to give you a real-time feel for system operations. In a real-world deployment, this would be connected to actual IoT sensors." }
            ];

            const faqContainer = document.getElementById('faq-container');
            if (faqContainer) {
                faqContainer.innerHTML = faqs.map((faq, index) => `
                    <div class="border-b border-gray-200 pb-4">
                        <button class="faq-question w-full flex justify-between items-center text-left text-gray-800 font-semibold focus:outline-none">
                            <span>${faq.q}</span>
                            <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                        </button>
                        <div class="faq-answer hidden mt-2 text-gray-600 text-sm">
                            ${faq.a}
                        </div>
                    </div>
                `).join('');

                // Add event listeners for the accordion
                document.querySelectorAll('.faq-question').forEach(button => {
                    button.addEventListener('click', () => {
                        const answer = button.nextElementSibling;
                        const icon = button.querySelector('i');

                        // Close other open answers
                        document.querySelectorAll('.faq-answer').forEach(ans => {
                            if (ans !== answer && !ans.classList.contains('hidden')) {
                                ans.classList.add('hidden');
                                ans.previousElementSibling.querySelector('i').classList.remove('rotate-180');
                            }
                        });

                        // Toggle current answer
                        answer.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    });
                });

                lucide.createIcons();
            }

            // Input validation functions
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function validateRequired(value) {
                return value.trim() !== '';
            }

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg animate-bounce z-50 ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            // Contact form submission
            const contactForm = document.getElementById('contact-form');
            contactForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const btnText = submitBtn.querySelector('.button-text');
                const btnLoader = submitBtn.querySelector('.button-loader');

                const name = document.getElementById('contact-name').value;
                const email = document.getElementById('contact-email').value;
                const subject = document.getElementById('contact-subject').value;
                const message = document.getElementById('contact-message').value;
    
                if (!validateRequired(name) || !validateRequired(email) || !validateRequired(subject) || !validateRequired(message)) {
                    showToast('All fields are required.', 'error');
                    return;
                }
                if (!validateEmail(email)) {
                    showToast('Please enter a valid email address.', 'error');
                    return;
                }
    
                // Set sending state
                submitBtn.disabled = true;
                btnText.textContent = 'Sending...';
                btnLoader.classList.remove('hidden');
    
                // Simulate sending with a timeout
                setTimeout(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    btnText.textContent = 'Send Message';
                    btnLoader.classList.add('hidden');
                    showToast('Message sent successfully! We will get back to you soon.');
                    contactForm.reset();
                }, 1500);
            });

            // Enhance grievance form validation
            const grievanceForm = document.getElementById('grievance-form');
            grievanceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const issueType = grievanceForm.querySelector('select').value;
                const location = grievanceForm.querySelector('input[type="text"]').value;
                const details = grievanceForm.querySelector('textarea').value;

                if (!validateRequired(location) || !validateRequired(details)) {
                    showToast('Please fill in all grievance fields.', 'error');
                    return;
                }

                // Proceed with AI analysis
                const aiGrievanceModal = document.getElementById('ai-grievance-modal');
                aiGrievanceModal.classList.remove('hidden');
                aiGrievanceModal.classList.add('show');

                const aiGrievanceModalContent = document.getElementById('ai-grievance-modal-content');
                const prompt = `You are a grievance assistant for a rural water supply system in India. A user reported: Type: ${issueType}, Location: ${location}, Details: ${details}. Suggest a structured action plan for the Gram Panchayat. Include sections for: Priority (Low/Medium/High), Required Resources, Step-by-Step Actions, and Estimated Time to Resolution.`;
                // Call the actual AI function, passing null for the button as we don't disable one here.
                callGeminiApi(prompt, null, aiGrievanceModalContent);
            });

            // Enhance Gemini API call with error handling and correct payload structure
            async function callGeminiApi(prompt, button, outputElement) {
                if (button) button.disabled = true;
                outputElement.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';

                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            candidateCount: 1,
                            maxOutputTokens: 512,
                            topP: 0.8,
                            topK: 40
                        }
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        outputElement.innerHTML = text.replace(/\n/g, '<br>').replace(/\*/g, '•');
                    } else {
                        outputElement.textContent = "Could not generate a response. Please try again.";
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    outputElement.textContent = "Failed to generate AI content. Please check your internet connection and try again.";
                } finally {
                    if (button) button.disabled = false;
                }
            }

            function displayPredictiveAlerts(alerts) {
                const container = document.getElementById("aiInsightsTable");
                if (!container) return;
                if (alerts.length === 0) {
                    container.innerHTML = `<p class="p-4 text-center text-gray-500">No predictive alerts at this time. System is stable.</p>`;
                    return;
                }
                let rowsHtml = `
                    <table class="min-w-full text-sm border border-gray-200 rounded">
                        <thead class="bg-gray-100">
                            <tr class="bg-gray-100">
                                <th class="px-3 py-2 text-left">Asset</th>
                                <th class="px-3 py-2 text-left">Type</th>
                                <th class="px-3 py-2 text-left">Location</th>
                                <th class="px-3 py-2 text-left">Predicted Issue</th>
                                <th class="px-3 py-2 text-left">Risk</th>
                                <th class="px-3 py-2 text-left hidden md:table-cell">Confidence</th>
                                <th class="px-3 py-2 text-left hidden lg:table-cell">Reason</th>
                                <th class="px-3 py-2 text-left hidden md:table-cell">Action</th>
                                <th class="px-3 py-2 text-left">Schedule</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                alerts.forEach(alert => {
                    let priorityClass = '';
                    switch (alert.priority) {
                        case 'High':
                            priorityClass = 'text-red-600';
                            break;
                        case 'Medium':
                            priorityClass = 'text-yellow-600';
                            break;
                        case 'Low':
                            priorityClass = 'text-green-600';
                            break;
                    }
                    rowsHtml += `
                        <tr class="border-t border-gray-200 even:bg-gray-50 hover:bg-indigo-50">
                            <td class="px-3 py-2 font-semibold">${alert.component}</td>
                            <td class="px-3 py-2">${alert.type}</td>
                            <td class="px-3 py-2">${alert.location}</td>
                            <td class="px-3 py-2">${alert.predictedIssue}</td>
                            <td class="px-3 py-2 ${priorityClass} font-semibold">${alert.risk}</td>
                            <td class="px-3 py-2 hidden md:table-cell">${alert.confidence}%</td>
                            <td class="px-3 py-2 hidden lg:table-cell">${alert.reason}</td>
                            <td class="px-3 py-2 hidden md:table-cell">${alert.action}</td>
                            <td class="px-3 py-2">${alert.schedule}</td>
                        </tr>
                    `;
                });
                rowsHtml += `</tbody></table>`;
                container.innerHTML = rowsHtml;
                lucide.createIcons();

                // Also update the maintenance reports section
                const reportsContainer = document.getElementById("reports-container");
                if (reportsContainer) {
                    reportsContainer.innerHTML = `
                        <h4 class="text-md font-semibold text-gray-800 mb-2">AI Predictive Maintenance Reports</h4>
                        <ul class="space-y-2">
                            ${alerts.map(a => `
                                <li class="p-3 bg-gray-50 rounded shadow">
                                    <strong>Component:</strong> ${a.component} <br>
                                    <strong>Predicted Issue:</strong> ${a.predictedIssue} <br>
                                    <strong>Risk:</strong> <span class="${a.risk>70?'text-red-600':a.risk>40?'text-yellow-600':'text-green-600'} font-semibold">${a.risk}</span> <br>
                                    <strong>Confidence:</strong> ${a.confidence}% <br>
                                    <strong>Reason:</strong> ${a.reason} <br>
                                    <strong>Action:</strong> ${a.action} <br>
                                    <strong>Schedule:</strong> ${a.schedule}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }
            }
            // --- Gemini AI Integration ---
            // demoData is now only fallback if villageData is missing

            const summaryBtn = document.getElementById('generate-summary-btn');
            if (summaryBtn) {
                summaryBtn.addEventListener('click', function() {
                    const data = getCurrentVillageData();
                    const grievancesText = data.grievances.length > 0
                        ? data.grievances.map(g => `${g.type} at ${g.location} (Status: ${g.status})`).join(', ')
                        : 'No new grievances';
                    const prompt = `You are a water management expert for a rural Indian village. Based on the following data for the past week for village ${villageSelector.value}, write a concise summary report for the Gram Panchayat in simple language. Highlight key achievements, identify potential issues, and suggest one practical focus area for the upcoming week. Data: Daily Water Supplied (kL): ${data.supply.join(', ')}. Daily Chlorine Levels (mg/L): ${data.chlorine.join(', ')}. Grievances: ${grievancesText}.`;
                    callGeminiApi(prompt, summaryBtn, document.getElementById('summary-output'));
                });
            }

            const forecastBtn = document.getElementById('generate-forecast-btn');
            if (forecastBtn) {
                forecastBtn.addEventListener('click', function() {
                    const data = getCurrentVillageData();
                    const logsText = data.logs?.length > 0 
                        ? data.logs.map(log => log.message).join('. ') 
                        : 'No recent logs.';
                    const pumpHours = data.pumpRunningHours || 'not available';
                    const filterCleanDate = data.filterLastCleanedDate || 'not available';
                    
                    const prompt = `You are a predictive maintenance AI for a rural Indian water supply system. Analyze the following data for a village and forecast potential operational issues for the next 7-10 days. Suggest specific, low-cost preventive maintenance actions. Data: Pump Running Hours: ${pumpHours}. Filter Last Cleaned: ${filterCleanDate}. Last 7 days water supplied ('000 Litres): ${data.supply.join(', ')}. Last 7 days chlorine levels (mg/L): ${data.chlorine.join(', ')}. Current operational alerts: "${data.alerts?.text || 'None'}". Recent logs: ${logsText}.`;
                    callGeminiApi(prompt, this, document.getElementById('aiInsightsTable'));
                });
            }

            // --- Live Data Subtab Logic ---
            const liveSubtabBtns = document.querySelectorAll('.live-subtab-btn');
            const liveSubtabContents = document.querySelectorAll('.live-subtab-content');
            liveSubtabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    liveSubtabBtns.forEach(b => {
                        b.classList.remove('border-blue-600', 'text-blue-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('border-blue-600', 'text-blue-600');
                    const subtab = this.dataset.subtab;
                    liveSubtabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(subtab).classList.remove('hidden');

                    // Initialize charts on subtab click
                    if (subtab === 'water-quality') {
                        initWaterQualityTrendChart();
                    }
                });
            });

            // --- Water Quality Chart & Inputs Binding ---
            function initWaterQualityTrendChart() {
                const ctx = document.getElementById('waterQualityTrendChart');
                if (!ctx) return;
                if (waterQualityTrendChart) waterQualityTrendChart.destroy();
                setCanvasHeight('waterQualityTrendChart');

                waterQualityTrendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Chlorine (mg/L)', 'pH', 'Turbidity (NTU)'],
                        datasets: [{
                            label: 'Current Value',
                            // Use data from the currently selected village
                            data: [villageData[villageSelector.value]?.chlorine || 0, villageData[villageSelector.value]?.ph || 0, villageData[villageSelector.value]?.turbidity || 0],
                            backgroundColor: [
                                'linear-gradient(135deg, #818cf8 0%, #38bdf8 100%)',
                                'linear-gradient(135deg, #34d399 0%, #06b6d4 100%)',
                                'linear-gradient(135deg, #fbbf24 0%, #f472b6 100%)'
                            ],
                            borderRadius: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            function updateHealthAdvisory() {
                const micro = document.getElementById('input-micro').value;
                const fluoride = parseFloat(document.getElementById('input-fluoride').value);
                const lead = parseFloat(document.getElementById('input-lead').value);
                const arsenic = parseFloat(document.getElementById('input-arsenic').value);
                const turbidity = parseFloat(document.getElementById('input-turbidity').value);
                const ph = parseFloat(document.getElementById('input-ph').value);

                const advisoryBox = document.getElementById('health-advisory-alert');
                const alertContent = document.getElementById('alert-content');
                const icon = advisoryBox.querySelector('i');

                let issues = [];
                if (micro !== "0") issues.push("Microbiological contamination detected.");
                if (fluoride > 1.5) issues.push("Fluoride level is high.");
                if (lead > 10) issues.push("Lead level exceeds safe limit.");
                if (arsenic > 10) issues.push("Arsenic level exceeds safe limit.");
                if (turbidity > 5) issues.push("Turbidity is high (cloudy water).");
                if (ph < 6.5 || ph > 8.5) issues.push("pH level is outside the recommended range.");

                if (issues.length > 0) {
                    advisoryBox.classList.remove('border-green-500');
                    advisoryBox.classList.add('border-red-500');
                    icon.className = 'w-6 h-6 text-red-500 mr-2';
                    icon.setAttribute('data-lucide', 'shield-alert');
                    alertContent.className = 'text-red-700';
                    alertContent.innerHTML = `<strong>Warning:</strong> Water may be unsafe.<ul>${issues.map(i => `<li class="list-disc ml-5">${i}</li>`).join('')}</ul>`;
                } else {
                    advisoryBox.classList.remove('border-red-500');
                    advisoryBox.classList.add('border-green-500');
                    icon.className = 'w-6 h-6 text-green-500 mr-2';
                    icon.setAttribute('data-lucide', 'shield-check');
                    alertContent.className = 'text-green-700';
                    alertContent.textContent = "All parameters are within safe limits. Water is safe for consumption.";
                }
                lucide.createIcons();
            }

            const qualityInputs = document.querySelectorAll('#water-quality-form input, #water-quality-form select');
            qualityInputs.forEach(input => {
                input.addEventListener('input', () => {
                    // Update display values for range sliders
                    if (input.type === 'range') {
                        const displayId = `display-${input.id.split('-')[1]}`;
                        const displayEl = document.getElementById(displayId);
                        if (displayEl) {
                            if (input.id.includes('ph')) {
                                displayEl.textContent = parseFloat(input.value).toFixed(2);
                            } else {
                                displayEl.textContent = parseFloat(input.value).toFixed(1);
                            }
                        }
                    }
                    updateHealthAdvisory();
                });
            });
            
            // Weekly Summary Auto-Generation and Mini Chart
            function generateWeeklySummary() {
                const summaryOutput = document.getElementById('summary-output');
                summaryOutput.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';

                setTimeout(() => {
                    const selectedVillage = document.getElementById('village-selector').value;
                    const data = villageData[selectedVillage];

                    if (data && data.supply && data.chlorine) {
                        const avgSupply = (data.supply.reduce((a, b) => a + b, 0) / data.supply.length).toFixed(2);
                        const avgChlorine = (data.chlorine.reduce((a, b) => a + b, 0) / data.chlorine.length).toFixed(2);
                        const grievancesCount = data.grievances ? data.grievances.length : 0;
                        const logsCount = data.logs ? data.logs.length : 0;

                        summaryOutput.innerHTML = `
    <strong>Weekly Summary for ${selectedVillage}:</strong><br>
    • Average Water Supply: ${avgSupply} kL/day<br>
    • Average Chlorine Level: ${avgChlorine} mg/L<br>
    • Grievances Reported: ${grievancesCount}<br>
    • Log Entries: ${logsCount}<br>
    • System Status: ${grievancesCount > 0 ? "Issues reported" : "All systems operational"}
                        `;
                    } else {
                        summaryOutput.innerHTML = "No data available for the selected village.";
                    }
                }, 800);
            }

            // Attachment preview logic
            const attachmentInput = document.getElementById('grievance-attachment');
            const attachmentPreview = document.getElementById('attachment-preview');
            attachmentInput?.addEventListener('change', function() {
                if (attachmentPreview) {
                    attachmentPreview.innerHTML = '';
                    Array.from(this.files).forEach(file => {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.className = 'w-16 h-16 object-cover rounded border';
                        attachmentPreview.appendChild(img);
                    });
                }
            });

            // Notification for new grievance
            document.getElementById('grievance-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                showToast("New grievance reported! Check Live Grievance Tracker.", "info");
                // Reset form
                this.reset();
                if (attachmentPreview) attachmentPreview.innerHTML = '';
            });

            // --- AI Grievance Modal Logic ---
            const closeAIGrievanceModalBtn = document.getElementById('close-ai-grievance-modal-btn');
            closeAIGrievanceModalBtn?.addEventListener('click', window.closeAIGrievanceModal);

            // Add listener for confirm grievance button
            const confirmGrievanceBtn = document.getElementById('confirm-grievance-btn');
            confirmGrievanceBtn?.addEventListener('click', () => {
                window.closeAIGrievanceModal();
                
                // Get data from the form
                const grievanceForm = document.getElementById('grievance-form');
                const issueType = grievanceForm.querySelector('select').value;
                const location = grievanceForm.querySelector('input[type="text"]').value;

                // Add to the data model
                const village = villageSelector.value;
                if (villageData[village]) {
                    villageData[village].grievances.unshift({
                        type: issueType,
                        location: location,
                        status: 'Pending',
                        date: 'Just now'
                    });
                    // Refresh the dashboard to show the new grievance
                    updateDashboardForVillage(village);
                }
                showToast("Grievance submitted successfully!", "success");
            });

            // --- AI Log Analysis ---
            const analyzeLogsBtn = document.getElementById('analyze-logs-btn');
            analyzeLogsBtn?.addEventListener('click', function() {
                const data = getCurrentVillageData();
                const logsText = data.logs?.length > 0
                    ? data.logs.map(log => `[${log.timestamp} ${log.level}] ${log.message}`).join('; ')
                    : 'No logs available.';
                
                const prompt = `As a water supply system expert, analyze the following chronological logs for a rural village. Provide a concise analysis with actionable recommendations. Structure your response with these exact headings: "Summary", "Identified Patterns", and "Recommendations". Under Recommendations, list items in a numbered, prioritized list. Logs: ${logsText}`;
                
                callGeminiApi(prompt, this, document.getElementById('log-analysis-output'));
            });

            // --- Log Filtering Logic ---
            const logFilterButtons = document.querySelectorAll('.log-filter-btn');
            logFilterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    logFilterButtons.forEach(b => b.classList.remove('active-filter', 'bg-white', 'text-blue-600', 'shadow-sm'));
                    this.classList.add('active-filter', 'bg-white', 'text-blue-600', 'shadow-sm');
                    
                    // Re-render logs with the new filter
                    const village = villageSelector.value;
                    updateDashboardForVillage(village);
                    lucide.createIcons(); // Re-render icons after updating the list
                });
            });

            // Log search input listener
            const logSearchInput = document.getElementById('log-search-input');
            logSearchInput?.addEventListener('input', () => {
                const village = villageSelector.value;
                updateDashboardForVillage(village);
            });

            // Routine check buttons
            const performCheckBtn = document.getElementById('perform-check-btn');
            const resetChecksBtn = document.getElementById('reset-checks-btn');
            performCheckBtn?.addEventListener('click', () => {
                // Simulate performing checks based on one of the valves
                const valveStatus = document.getElementById('valve-v1-status')?.textContent || "OPEN";
                const valveCheckStatusEl = document.getElementById('valve-check-status');
                if (valveCheckStatusEl) valveCheckStatusEl.textContent = valveStatus;

                const lastQualityTestTime = new Date().toLocaleTimeString();
                const lastQualityTestEl = document.getElementById('last-quality-test');
                if (lastQualityTestEl) lastQualityTestEl.textContent = "Today " + lastQualityTestTime;
                
                showToast("Routine checks performed successfully!", "success");
            });
            resetChecksBtn?.addEventListener('click', () => {
                dailyPumpHours = 0;
                const dailyPumpHoursEl = document.getElementById('daily-pump-hours');
                if (dailyPumpHoursEl) dailyPumpHoursEl.textContent = dailyPumpHours.toFixed(1) + " hrs";

                const valveCheckStatusEl = document.getElementById('valve-check-status');
                if (valveCheckStatusEl) valveCheckStatusEl.textContent = "OPEN";

                const leakDetectionStatusEl = document.getElementById('leak-detection-status');
                if (leakDetectionStatusEl) {
                    leakDetectionStatusEl.textContent = "No Leaks Detected";
                    leakDetectionStatusEl.className = "font-bold text-green-600";
                }

                const lastQualityTestEl = document.getElementById('last-quality-test');
                if (lastQualityTestEl) lastQualityTestEl.textContent = "Not performed today";

                const checkAlertEl = document.getElementById('check-alert');
                if (checkAlertEl) checkAlertEl.classList.add('hidden');

                showToast("Daily checks reset!", "info");
            });
        }); // End of DOMContentLoaded
        
        // --- Simulation Controls Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            const simNormalBtn = document.getElementById('sim-normal-btn');
            const simLeakBtn = document.getElementById('sim-leak-btn');
            const simPumpFailureBtn = document.getElementById('sim-pump-failure-btn');
            const simStatusEl = document.getElementById('simulation-status');
            const simBtns = document.querySelectorAll('.simulation-btn');

            function setSimulationState(state, statusText, statusColor) {
                simulationState = state;
                simStatusEl.innerHTML = `<span class="w-3 h-3 ${statusColor} rounded-full mr-2 pulse-live"></span><span class="text-sm font-semibold text-gray-600">${statusText}</span>`;
                
                simBtns.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });

                const activeBtn = document.getElementById(`sim-${state.replace('_', '-')}-btn`);
                if (activeBtn) {
                    activeBtn.classList.add('bg-blue-600', 'text-white');
                    activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                }
            }

            simNormalBtn?.addEventListener('click', () => setSimulationState('normal', 'Normal Operation', 'bg-green-500'));
            simLeakBtn?.addEventListener('click', () => setSimulationState('leak', 'Leak Simulated', 'bg-yellow-500'));
            simPumpFailureBtn?.addEventListener('click', () => setSimulationState('pump_failure', 'Pump Failure Simulated', 'bg-red-500'));
        });

        // --- AI-Based Log Analysis Enhancement ---
        function analyzeLogsAI() {
            const logsList = document.querySelectorAll('#logs-list li');
            const output = document.getElementById('log-analysis-output');
            if(!output) return;

            let errorCount = 0, warnCount = 0, infoCount = 0;
            const recurringIssues = {};

            logsList.forEach(log => {
                const text = log.querySelector('p')?.textContent || '';
                if(text.includes('[ERROR]')) { errorCount++; recurringIssues[text] = (recurringIssues[text]||0)+1; }
                else if(text.includes('[WARN]')) { warnCount++; recurringIssues[text] = (recurringIssues[text]||0)+1; }
                else if(text.includes('[INFO]')) { infoCount++; }
            });

            let summary = `AI Log Analysis Summary:\n\n`;
            summary += `Total Errors: ${errorCount}\nTotal Warnings: ${warnCount}\nTotal Info Messages: ${infoCount}\n\n`;

            summary += `Recurring Issues Detected:\n`;
            for(const issue in recurringIssues) {
                if(recurringIssues[issue] > 1) {
                    summary += `- "${issue}" occurred ${recurringIssues[issue]} times. Suggested action: Investigate immediately.\n`;
                }
            }

            if(errorCount > 0) summary += `\nCritical Alert: Some components may require immediate attention.`;
            else summary += `\nSystem appears stable. Continue monitoring.`;

            output.textContent = summary;
        }


    // --- Household Modal Logic ---
    // Global variable for household modal chart instance
    if (typeof householdModalChartInstance === 'undefined') {
        window.householdModalChartInstance = null;
    }

    // Expose modal functions globally
    window.openHouseholdModal = function(houseId) {
        // Show the modal
        const modal = document.getElementById('household-modal');
        if (!modal) return;
        modal.classList.remove('hidden');

        // Set modal title
        const modalTitle = document.getElementById('household-modal-title');
        if (modalTitle) {
            modalTitle.textContent = `Household ${houseId} - Usage History`;
        }

        // Generate random historical data for demo: 8 weeks
        const weeks = [];
        const usage = [];
        for (let i = 7; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i * 7);
            // Format as "Wk 1", "Wk 2", etc.
            weeks.push(`Week ${8 - i}`);
            // Demo: random usage between 90 and 170L
            usage.push(Math.floor(90 + Math.random() * 80));
        }

        // Render Chart.js line chart in modal
        const ctx = document.getElementById('household-modal-chart');
        if (window.householdModalChartInstance) {
            window.householdModalChartInstance.destroy();
            window.householdModalChartInstance = null;
        }
        if (ctx) {
            ctx.height = 240;
            ctx.style.height = "240px";
            window.householdModalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Weekly Usage (L)',
                        data: usage,
                        borderColor: 'rgba(59,130,246,1)',
                        backgroundColor: 'rgba(59,130,246,0.12)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(59,130,246,1)',
                        pointRadius: 4
                    }]
                },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
            });
        }
    }

    window.closeHouseholdModal = function() {
        const modal = document.getElementById('household-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        // Destroy chart instance
        if (window.householdModalChartInstance) {
            window.householdModalChartInstance.destroy();
            window.householdModalChartInstance = null;
        }
    }

    // Trigger analysis on button click
    document.getElementById('analyze-logs-btn')?.addEventListener('click', analyzeLogsAI);

    // Optional: Live update every 10s to simulate AI monitoring
    setInterval(analyzeLogsAI, 10000);
    </script>
    <!-- Fixes & Stabilization Patch -->
    <script>
    // --- Global Tab Switching Fix ---
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const tabContents = document.querySelectorAll('.tab-content');
    const headerTitle = document.getElementById('header-title');

    sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = link.getAttribute('data-tab');
        sidebarLinks.forEach(l => l.classList.remove('active'));
        tabContents.forEach(t => t.classList.remove('active'));
        link.classList.add('active');
        const targetContent = document.getElementById(targetTab);
        if (targetContent) targetContent.classList.add('active');
        if (headerTitle) headerTitle.textContent = link.textContent.trim();
        try { lucide.createIcons(); } catch(e){}
      });
    });

    // --- Button Functionality Placeholders ---
    document.getElementById('analyze-logs-btn')?.addEventListener('click', ()=>{
      alert('🧠 AI Log Analysis feature coming soon!');
    });
    document.getElementById('generate-summary-btn')?.addEventListener('click', ()=>{
      alert('✨ Generating weekly summary...');
    });
    document.getElementById('generate-forecast-btn')?.addEventListener('click', ()=>{
      alert('🔮 Generating predictive maintenance forecast...');
    });

    // --- Safe Lucide Icon Refresh ---
    try { lucide.createIcons(); } catch(err) {
      console.warn('Lucide icon refresh skipped:', err);
    }

    // --- Map & Chart Safety Guards ---
    window.addEventListener('error', function(event){
      console.error('Dashboard JS Error:', event.message);
    });

    // Prevent layout overflow on mobile
    document.querySelectorAll('table, #map-container').forEach(el=>{
      el.style.maxWidth = '100%';
      el.style.overflowX = 'auto';
    });

    // --- Footer Note ---
    console.log('✅ Dashboard build stable – last updated 2025-10-06');
    </script>
    <!-- Smart Auto-Refreshing System Logs -->
    <script>
    (function(){
      const logsList = document.getElementById('logs-list');
      if (!logsList) return;

      // --- Utility: Add new log entry ---
      function addLog(level, message) {
        const now = new Date();
        const colors = { INFO: 'blue', WARN: 'yellow', ERROR: 'red' };

        const li = document.createElement('li');
        li.className = 'border p-3 rounded-lg bg-gray-50 flex justify-between items-center animate-fadeIn';
        li.innerHTML = `
          <div>
            <p class="font-semibold text-gray-800">[${level}] ${message}</p>
            <p class="text-sm text-gray-500">${now.toLocaleString()}</p>
          </div>
          <span class="text-xs bg-${colors[level]}-100 text-${colors[level]}-800 px-2 py-1 rounded">${level}</span>
        `;
        logsList.prepend(li);
        while (logsList.children.length > 10) logsList.removeChild(logsList.lastChild);
      }

      // --- Simulation Logic ---
      function simulateSystemChanges() {
        // Randomly adjust pump temperatures
        window.systemState.pumps.forEach(p => {
          p.temp += (Math.random() * 4 - 2);
          if (p.temp > 85) {
            addLog('WARN', `${p.id} running hot (${p.temp.toFixed(1)}°C)`);
          }
          if (p.temp > 95) {
            addLog('ERROR', `${p.id} overheated and stopped!`);
            p.status = 'OFF';
            p.temp = 70;
          }
        });

        // Randomly fluctuate reservoir
        window.systemState.reservoirLevel += (Math.random() * 10 - 5);
        if (window.systemState.reservoirLevel < 40) {
          addLog('WARN', `Reservoir Level critical (${window.systemState.reservoirLevel.toFixed(0)}%)`);
        } else if (window.systemState.reservoirLevel > 90) {
          addLog('INFO', `Reservoir at optimal level (${window.systemState.reservoirLevel.toFixed(0)}%)`);
        }

        // Simulate sensor readings
        window.systemState.sensors.forEach(s => {
          s.value += (Math.random() * 0.3 - 0.15);
          if (s.value < 6.5 || s.value > 7.5) {
            addLog('WARN', `Sensor ${s.id} reading out of range (${s.value.toFixed(2)} pH)`);
          }
        });

        // Occasionally trigger a general info message
        if (Math.random() < 0.3) {
          const infoMessages = [
            'System diagnostics completed.',
            'All nodes responding normally.',
            'Water flow consistent across all regions.',
            'Scheduled backup successful.',
            'Pressure levels stable throughout system.'
          ];
          addLog('INFO', infoMessages[Math.floor(Math.random() * infoMessages.length)]);
        }

        try { lucide.createIcons(); } catch(e){}
      }

      // --- Animation Style ---
      const style = document.createElement('style');
      style.innerHTML = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
      `;
      document.head.appendChild(style);

      // --- Run simulation every 10 seconds ---
      setInterval(simulateSystemChanges, 10000);
    })();
    </script>
    <!-- Household Details Modal -->
    <div id="household-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg relative p-6">
        <button onclick="closeHouseholdModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700" aria-label="Close"><i data-lucide="x"></i></button>
        <h2 id="household-modal-title" class="text-xl font-semibold text-gray-800 mb-4" tabindex="-1">Household Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
            <div>
                <h3 class="text-md font-semibold text-gray-700 mb-2">Usage History (8 Weeks)</h3>
                <canvas id="household-modal-chart"></canvas>
            </div>
        </div>
      </div>
    </div>
<!-- AI Grievance Action Plan Modal -->
    <div id="ai-grievance-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[1000] hidden" role="dialog" aria-modal="true" aria-labelledby="ai-modal-title">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full m-4 transform transition-all duration-300 scale-95" role="document">
            <button onclick="closeAIGrievanceModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700" aria-label="Close"><i data-lucide="x"></i></button>
        <div class="flex justify-between items-center mb-4">
            <h3 id="ai-modal-title" class="text-2xl font-bold text-gray-800 flex items-center" tabindex="-1">
                <i data-lucide="sparkles" class="mr-2 text-blue-500"></i> AI-Suggested Action Plan
            </h3>
            <button id="close-ai-grievance-modal-btn" class="text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="ai-grievance-modal-content" class="text-gray-700 space-y-4 max-h-[60vh] overflow-y-auto p-2"></div>
        <div class="mt-6 flex justify-end space-x-4">
            <button id="confirm-grievance-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 flex items-center">
                <i data-lucide="check-circle" class="mr-2 h-5 w-5"></i> Confirm & Submit Grievance
            </button>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const performBtn = document.getElementById('perform-check-btn');
    const resetBtn = document.getElementById('reset-checks-btn');

    performBtn?.addEventListener('click', () => {
        // Simulate a routine check
        lastQualityTest = new Date().toLocaleString();
        simulationState = 'normal'; // Reset simulation to normal
        updateSensorData(); // Refresh charts and indicators

        // Show a green toast
        const toast = document.createElement('div');
        toast.textContent = "Routine check performed successfully!";
        toast.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-bounce";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    });

    resetBtn?.addEventListener('click', () => {
        // Reset daily checks
        dailyPumpHours = 0;
        valveCheckStatus = "OPEN";
        leakDetectionStatus = "No Leaks Detected";
        lastQualityTest = "Not Performed";

        updateSensorData(); // Refresh UI

        // Show a yellow toast
        const toast = document.createElement('div');
        toast.textContent = "Daily checks have been reset!";
        toast.className = "fixed bottom-4 right-4 bg-yellow-600 text-white px-4 py-2 rounded shadow-lg animate-bounce";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    });
});
</script>
</body>
</html>
