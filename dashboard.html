<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jal Jagran - Modern Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e7ff 100%);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar-link.active {
            background: linear-gradient(90deg, #6366f1 0%, #06b6d4 100%);
            color: #fff;
            box-shadow: 0 4px 12px 0 rgba(6,182,212,0.15);
        }
        .sidebar-link.active i {
            color: #fff;
        }
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link:hover {
            background: linear-gradient(90deg, #818cf8 0%, #38bdf8 100%);
            color: #fff;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #818cf8 0%, #06b6d4 100%);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #06b6d4;
        }
        /* Loader animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06b6d4;
            border-right: 4px solid #818cf8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-live {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Stat card backgrounds */
        .stat-card-gradient-1 { background: linear-gradient(135deg, #818cf8 0%, #38bdf8 100%); }
        .stat-card-gradient-2 { background: linear-gradient(135deg, #34d399 0%, #06b6d4 100%); }
        .stat-card-gradient-3 { background: linear-gradient(135deg, #fbbf24 0%, #f472b6 100%); }
        .stat-card-gradient-4 { background: linear-gradient(135deg, #f87171 0%, #fbbf24 100%); }
    </style>
</head>
<body class="flex antialiased">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-blue-900 text-blue-100 flex flex-col h-screen sticky top-0 shadow-lg">
        <div class="p-6 flex items-center space-x-3 border-b border-blue-800">
            <div class="bg-blue-500 p-2 rounded-lg">
                <i data-lucide="droplets" class="w-6 h-6 text-white"></i>
            </div>
            <span class="font-bold text-xl text-white">Jal Jagran</span>
        </div>
        <nav class="mt-6 flex-1 px-4 space-y-2">
            <a href="#overview" data-tab="overview" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-semibold">Overview</span>
            </a>
            <a href="#households" data-tab="households" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="font-semibold">Households</span>
            </a>
            <a href="#live-data" data-tab="live-data" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span class="font-semibold">Live Data</span>
            </a>
            <a href="#ai-insights" data-tab="ai-insights" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                <span class="font-semibold">AI Insights</span>
            </a>
            <a href="#grievances" data-tab="grievances" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="alert-octagon" class="w-5 h-5"></i>
                <span class="font-semibold">Grievances</span>
            </a>
            <a href="#logs" data-tab="logs" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="font-semibold">System Logs</span>
            </a>
            <a href="#contact" data-tab="contact" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-lg text-blue-200">
                <i data-lucide="mail-question" class="w-5 h-5"></i>
                <span class="font-semibold">Support</span>
            </a>
        </nav>
        <div class="p-4 border-t border-blue-800">
            <div class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/60a5fa/FFFFFF?text=A" alt="Admin" class="rounded-full">
                <div>
                    <p class="font-semibold text-white text-sm">Admin User</p>
                    <p class="text-xs text-blue-300">District Officer</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 id="header-title" class="text-3xl font-bold text-gray-800">Overview</h1>
                <p class="text-gray-500 mt-1">Welcome back! Here's a summary of the water supply system.</p>
            </div>
            <div class="flex items-center space-x-4">
                 <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 w-64 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>
                <button class="relative p-2 text-gray-600 hover:bg-gray-200 rounded-full">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500"></span>
                </button>
            </div>
        </header>

        <!-- Tab Content Area -->
        <div id="tab-container">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="mb-8">
                    <!-- Panchayat & Village Selector -->
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <div>
                            <label for="panchayat-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Panchayat</label>
                            <select id="panchayat-selector" class="w-full md:w-56 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <!-- Panchayat options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="village-selector" class="block text-sm font-medium text-gray-700 mb-1">Select Village</label>
                            <select id="village-selector" class="w-full md:w-56 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <!-- Village options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Stat Card 1 -->
                    <div class="stat-card-gradient-1 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                        <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="home" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Total Households</p>
                            <h3 id="total-households" class="text-3xl font-bold">1,250</h3>
                        </div>
                    </div>
                    <!-- Stat Card 2 -->
                    <div class="stat-card-gradient-2 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                        <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="plug-zap" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Active Connections</p>
                            <h3 id="active-connections" class="text-3xl font-bold">1,220</h3>
                        </div>
                    </div>
                    <!-- Stat Card 3 -->
                    <div class="stat-card-gradient-3 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                         <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="target" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Coverage</p>
                            <h3 id="coverage" class="text-3xl font-bold">98%</h3>
                        </div>
                    </div>
                     <!-- Stat Card 4 -->
                    <div class="stat-card-gradient-4 p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex items-center space-x-4 text-white">
                         <div class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                            <i data-lucide="alert-circle" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">Active Alerts</p>
                            <h3 id="active-alerts" class="text-3xl font-bold">3</h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Weekly Water Supplied (kL)</h3>
                        <canvas id="waterChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">System Status</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Main Pump</span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">Operational</span>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="text-gray-600">Filter Unit A</span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">Operational</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Chlorine Levels</span>
                                 <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">Optimal</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Reservoir Level</span>
                                <div class="w-1/2 bg-gray-200 rounded-full h-2.5">
                                  <div class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                                </div>
                                <span class="font-semibold text-gray-700">85%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Households Tab -->
            <div id="households" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                            Household Water Statistics 
                            <span class="ml-3 flex items-center text-xs font-semibold text-green-600 pulse-live"><span class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></span>LIVE</span>
                        </h3>
                         <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
                             <i data-lucide="plus" class="w-5 h-5"></i>
                             <span>Add Household</span>
                         </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-4 font-semibold text-gray-600">House ID</th>
                                    <th class="p-4 font-semibold text-gray-600">Weekly Usage</th>
                                    <th class="p-4 font-semibold text-gray-600">Avg. Daily Need</th>
                                    <th class="p-4 font-semibold text-gray-600">Status</th>
                                    <th class="p-4 font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="households-table-body">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H001</td>
                                    <td class="p-4 text-gray-600">125 L</td>
                                    <td class="p-4 text-gray-600">130 L</td>
                                    <td class="p-4"><span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Sufficient</span></td>
                                    <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H001')">Details</button></td>
                                </tr>
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H002</td>
                                    <td class="p-4 text-gray-600">163 L</td>
                                    <td class="p-4 text-gray-600">150 L</td>
                                    <td class="p-4"><span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>Overuse</span></td>
                                     <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H002')">Details</button></td>
                                </tr>
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 text-gray-800 font-medium">UJ-H003</td>
                                    <td class="p-4 text-gray-600">95 L</td>
                                    <td class="p-4 text-gray-600">140 L</td>
                                    <td class="p-4"><span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">Deficit</span></td>
                                     <td class="p-4"><button class="text-blue-600 hover:underline" onclick="openHouseholdModal('UJ-H003')">Details</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Live Data Tab -->
            <div id="live-data" class="tab-content">
                <!-- Sub-tabs for Live Data -->
                <div class="mb-6 flex space-x-2 border-b border-gray-200">
                    <button class="live-subtab-btn px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-semibold focus:outline-none" data-subtab="live-charts">Charts</button>
                    <button class="live-subtab-btn px-4 py-2 border-b-2 border-transparent text-gray-500 font-semibold focus:outline-none" data-subtab="water-quality">Water Quality</button>
                </div>
                <!-- Charts Subtab -->
                <div id="live-charts" class="live-subtab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Chlorine Levels (mg/L)</h3>
                            <canvas id="chlorineChart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">FHTC Growth</h3>
                            <canvas id="fhtcChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6 bg-white p-6 rounded-2xl shadow-md">
                      <h3 class="text-lg font-semibold text-gray-700 mb-4">Real-Time Sensor Simulation</h3>
                      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div>
                          <p class="font-medium text-gray-600 mb-1">Pump Status:</p>
                          <p id="pump-status" class="font-bold text-green-600">ON</p>
                          <p class="font-medium text-gray-600 mt-3 mb-1">Valve Position:</p>
                          <p id="valve-status" class="font-bold text-green-600">OPEN</p>
                          <p class="font-medium text-gray-600 mt-3 mb-1">Reservoir Level:</p>
                          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                            <div id="reservoir-level" class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                          </div>
                          <span class="font-semibold text-gray-700">85%</span>
                        </div>
                        <div><canvas id="flowRateChart" height="200"></canvas></div>
                        <div><canvas id="pressureChart" height="200"></canvas></div>
                      </div>
                    </div>
                </div>
                <!-- Water Quality Subtab -->
                <div id="water-quality" class="live-subtab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Simulate Water Tests</h3>
                            <form id="water-quality-form" class="space-y-4 text-sm">
                                <div>
                                    <label class="font-medium text-gray-700">Microbiological</label>
                                    <select id="input-micro" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="0">Not Detected</option>
                                        <option value="1">E. coli Detected</option>
                                        <option value="2">Coliform Detected</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-gray-700">Fluoride (mg/L)</label>
                                    <input type="range" id="input-fluoride" min="0" max="3" step="0.1" value="0.8" class="w-full">
                                    <div class="text-xs text-gray-500 mt-1">Value: <span id="display-fluoride">0.8</span> mg/L</div>
                                </div>
                                <div>
                                    <label class="font-medium text-gray-700">Lead (µg/L)</label>
                                    <input type="range" id="input-lead" min="0" max="20" step="0.5" value="2" class="w-full">
                                    <div class="text-xs text-gray-500 mt-1">Value: <span id="display-lead">2.0</span> µg/L</div>
                                </div>
                                <div>
                                    <label class="font-medium text-gray-700">Arsenic (µg/L)</label>
                                    <input type="range" id="input-arsenic" min="0" max="20" step="0.5" value="3" class="w-full">
                                    <div class="text-xs text-gray-500 mt-1">Value: <span id="display-arsenic">3.0</span> µg/L</div>
                                </div>
                                <div>
                                    <label class="font-medium text-gray-700">Turbidity (NTU)</label>
                                    <input type="range" id="input-turbidity" min="0" max="10" step="0.1" value="2.0" class="w-full">
                                    <div class="text-xs text-gray-500 mt-1">Value: <span id="display-turbidity">2.0</span> NTU</div>
                                </div>
                                <div>
                                    <label class="font-medium text-gray-700">pH</label>
                                    <input type="range" id="input-ph" min="5" max="9" step="0.01" value="7.0" class="w-full">
                                    <div class="text-xs text-gray-500 mt-1">Value: <span id="display-ph">7.00</span></div>
                                </div>
                            </form>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div id="health-advisory-alert" class="bg-white p-6 rounded-2xl shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                    <i data-lucide="shield-check" class="w-6 h-6 text-green-500 mr-2"></i>
                                    Health Advisory
                                </h3>
                                <div id="alert-content" class="text-green-700">
                                    All parameters are within safe limits. Water is safe for consumption.
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Historical Water Quality Trends (30 Days)</h3>
                                <canvas id="waterQualityTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="ai-insights" class="tab-content"> 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Gemini AI Weekly Summary -->
                    <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-blue-500 flex flex-col">
                        <div class="flex items-center space-x-3 mb-3">
                            <i data-lucide="lightbulb" class="w-6 h-6 text-blue-500"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Weekly Summary (Gemini AI)</h3>
                        </div>
                        <button id="generate-summary-btn" class="mb-3 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2 disabled:bg-blue-300">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                            <span>Generate Summary</span>
                        </button>
                        <div id="summary-output" class="bg-blue-50 p-4 rounded-lg text-gray-700 min-h-[200px] whitespace-pre-wrap flex items-center justify-center">
                            Click the button to generate an AI-powered summary of the week's activities and data trends.
                        </div>
                    </div>
                    <!-- Gemini AI Maintenance Forecast -->
                    <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-orange-500 flex flex-col" id="maintenance-forecast-section">
                        <div class="flex items-center space-x-3 mb-3">
                            <i data-lucide="cpu" class="w-6 h-6 text-orange-500"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Predictive Maintenance Schedule</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 font-semibold text-gray-600">Asset/System</th>
                                        <th class="p-3 font-semibold text-gray-600">Predicted Issue</th>
                                        <th class="p-3 font-semibold text-gray-600">Priority</th>
                                        <th class="p-3 font-semibold text-gray-600">Suggested Action</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-forecast-table-body">
                                    <!-- Rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grievances Tab -->
            <div id="grievances" class="tab-content">
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Report an Issue</h3>
                        <form class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Issue Type</label>
                                <select class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <option>Pipe Leakage</option>
                                    <option>No Water Supply</option>
                                    <option>Contaminated Water</option>
                                    <option>Billing Issue</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Location / Landmark</label>
                                <input type="text" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Near Ward 2 Park">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Details</label>
                                <textarea class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" placeholder="Provide a brief description..."></textarea>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Attach Photos / Files</label>
                                <input type="file" id="grievance-attachment" multiple class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <div id="attachment-preview" class="mt-2 flex space-x-2 flex-wrap"></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center justify-center">
                                <i data-lucide="sparkles" class="mr-2 h-5 w-5"></i>Analyze & Suggest Action Plan
                            </button>
                        </form>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Live Grievance Tracker</h3>
                         <div class="space-y-4">
                             <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg" data-grievance-id="1">
                                 <div class="bg-yellow-100 text-yellow-600 p-2 rounded-full mt-1"><i data-lucide="wrench" class="w-5 h-5"></i></div>
                                 <div>
                                     <p class="font-semibold">Pipe leakage at Ward 2</p>
                                     <p class="text-sm text-gray-500">Status: <span class="grievance-status px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">In Progress</span></p>
                                     <select class="grievance-status-select mt-2 border rounded px-2 py-1 text-sm">
                                         <option value="In Progress" selected>In Progress</option>
                                         <option value="Resolved">Resolved</option>
                                     </select>
                                     <p class="text-xs text-gray-400">Reported 2 hours ago</p>
                                 </div>
                             </div>
                             <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg" data-grievance-id="2">
                                  <div class="bg-green-100 text-green-600 p-2 rounded-full mt-1"><i data-lucide="check-circle" class="w-5 h-5"></i></div>
                                 <div>
                                     <p class="font-semibold">Low pressure at Market Area</p>
                                     <p class="text-sm text-gray-500">Status: <span class="grievance-status px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Resolved</span></p>
                                     <select class="grievance-status-select mt-2 border rounded px-2 py-1 text-sm">
                                         <option value="In Progress">In Progress</option>
                                         <option value="Resolved" selected>Resolved</option>
                                     </select>
                                     <p class="text-xs text-gray-400">Resolved yesterday</p>
                                 </div>
                             </div>
                              <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg" data-grievance-id="3">
                                  <div class="bg-red-100 text-red-600 p-2 rounded-full mt-1"><i data-lucide="shield-alert" class="w-5 h-5"></i></div>
                                 <div>
                                     <p class="font-semibold">Water Quality Concern in Sector 5</p>
                                     <p class="text-sm text-gray-500">Status: <span class="grievance-status px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">New</span></p>
                                     <!-- No status select for New status -->
                                     <p class="text-xs text-gray-400">Reported 15 mins ago</p>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Recent System Logs</h3>
                    <ul class="space-y-3">
                       <li class="flex items-center space-x-3 text-sm p-3 bg-gray-50 rounded-lg">
                          <i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>
                          <span class="text-gray-500">10/03/2025 09:30 AM</span>
                          <span class="font-medium text-gray-800">FTK Test Passed at School Point</span>
                       </li>
                       <li class="flex items-center space-x-3 text-sm p-3 bg-gray-50 rounded-lg">
                          <i data-lucide="sliders-horizontal" class="w-5 h-5 text-blue-500"></i>
                           <span class="text-gray-500">10/03/2025 08:00 AM</span>
                          <span class="font-medium text-gray-800">Pump Maintenance Scheduled for UJ-P1</span>
                       </li>
                       <li class="flex items-center space-x-3 text-sm p-3 bg-gray-50 rounded-lg">
                          <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500"></i>
                           <span class="text-gray-500">09/03/2025 11:45 PM</span>
                          <span class="font-medium text-gray-800">Pressure drop detected in Zone B pipeline.</span>
                       </li>
                    </ul>
                </div>
            </div>

            <!-- Contact Tab -->
            <div id="contact" class="tab-content">
                <div class="bg-white p-8 rounded-2xl shadow-md max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2 text-center">Get in Touch</h3>
                    <p class="text-center text-gray-500 mb-6">Have a question or need support? Fill out the form below.</p>
                    <form class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="John Doe">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="you@example.com">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Subject</label>
                            <input type="text" class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Technical Support">
                        </div>
                        <div>
                           <label class="text-sm font-medium text-gray-700">Message</label>
                           <textarea class="mt-1 w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="5" placeholder="Your message here..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition shadow-md">Send Message</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide Icons
            lucide.createIcons();

            // Tab switching logic
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const tabContents = document.querySelectorAll('.tab-content');
            const headerTitle = document.getElementById('header-title');

            // --- Chart Section ---
            // Chart instances
            let waterChartInstance, chlorineChartInstance, fhtcChartInstance, smartMeterInterval, waterQualityTrendChart;

            // Chart global configuration
            const chartFont = "'Plus Jakarta Sans', sans-serif";
            Chart.defaults.font.family = chartFont;
            Chart.defaults.plugins.legend.position = 'bottom';

            // Chart Initializers (always destroy previous instance before creating new)
            function setCanvasHeight(id, heightPx = 280) {
                const canvas = document.getElementById(id);
                if (canvas) {
                    canvas.height = heightPx;
                    canvas.style.height = heightPx + "px";
                }
            }

            function initWaterChart() {
                const ctx = document.getElementById('waterChart');
                if (!ctx) return;
                if (waterChartInstance) {
                    waterChartInstance.destroy();
                    waterChartInstance = null;
                }
                setCanvasHeight('waterChart');
                waterChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                        datasets: [{
                            label: 'Supply (kL)',
                            data: [95, 98, 97, 99, 96, 98, 100],
                            backgroundColor: [
                                'rgba(59,130,246,0.85)',
                                'rgba(16,185,129,0.85)',
                                'rgba(249,115,22,0.85)',
                                'rgba(236,72,153,0.85)',
                                'rgba(139,92,246,0.85)',
                                'rgba(251,191,36,0.85)',
                                'rgba(6,182,212,0.85)'
                            ],
                            borderColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 12,
                            hoverBackgroundColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ]
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            function initChlorineChart() {
                const ctx = document.getElementById('chlorineChart');
                if (!ctx) return;
                if (chlorineChartInstance) {
                    chlorineChartInstance.destroy();
                    chlorineChartInstance = null;
                }
                setCanvasHeight('chlorineChart');
                chlorineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                        datasets: [{
                            label: 'Chlorine (mg/L)',
                            data: [0.5, 0.4, 0.6, 0.5, 0.4, 0.5, 0.5],
                            borderColor: 'rgba(236,72,153,1)',
                            backgroundColor: 'rgba(236,72,153,0.15)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(236,72,153,1)',
                            pointRadius: 5
                        }]
                    },
                    options: { 
                        responsive: false, 
                        maintainAspectRatio: false, 
                        scales: { y: { grid: { drawBorder: false } }, x: { grid: { display: false } } } 
                    }
                });
            }

            function initFhtcChart() {
                const ctx = document.getElementById('fhtcChart');
                if (!ctx) return;
                if (fhtcChartInstance) {
                    fhtcChartInstance.destroy();
                    fhtcChartInstance = null;
                }
                setCanvasHeight('fhtcChart');
                fhtcChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["Jan", "Feb", "Mar", "Apr", "May"],
                        datasets: [{
                            label: 'Connections',
                            data: [1000, 1100, 1150, 1200, 1250],
                            borderColor: 'rgba(34,197,94,1)',
                            backgroundColor: 'rgba(34,197,94,0.15)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(34,197,94,1)',
                            pointRadius: 5
                        }]
                    },
                    options: { 
                        responsive: false, 
                        maintainAspectRatio: false, 
                        scales: { y: { grid: { drawBorder: false } }, x: { grid: { display: false } } } 
                    }
                });
            }
            // --- Real-Time Sensor Integration (Demo for MVP) ---
            let sensorCharts = {};

            function initSensorCharts() {
                const ctxFlow = document.getElementById('flowRateChart');
                const ctxPressure = document.getElementById('pressureChart');
                if (!ctxFlow || !ctxPressure) return;

                sensorCharts.flow = new Chart(ctxFlow, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 10}, (_, i) => `T-${10-i}s`),
                        datasets: [{
                            label: 'Flow Rate (L/min)',
                            data: Array(10).fill().map(()=>Math.random()*100+300),
                            borderColor: 'rgba(37,99,235,1)',
                            backgroundColor: 'rgba(37,99,235,0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: false, maintainAspectRatio: false }
                });

                sensorCharts.pressure = new Chart(ctxPressure, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 10}, (_, i) => `T-${10-i}s`),
                        datasets: [{
                            label: 'Pressure (bar)',
                            data: Array(10).fill().map(()=>Math.random()*2+4),
                            borderColor: 'rgba(16,185,129,1)',
                            backgroundColor: 'rgba(16,185,129,0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: false, maintainAspectRatio: false }
                });
            }

            function updateSensorData() {
                const pumpStatus = document.getElementById('pump-status');
                const valveStatus = document.getElementById('valve-status');
                const reservoirLevel = document.getElementById('reservoir-level');

                if (pumpStatus) pumpStatus.textContent = Math.random() > 0.2 ? "ON" : "OFF";
                if (valveStatus) valveStatus.textContent = Math.random() > 0.3 ? "OPEN" : "CLOSED";
                if (reservoirLevel) {
                    const level = Math.floor(60 + Math.random() * 40);
                    reservoirLevel.style.width = level + "%";
                    reservoirLevel.nextElementSibling.textContent = level + "%";
                }

                Object.values(sensorCharts).forEach(chart => {
                    if (!chart || !chart.data || !chart.data.datasets[0]) return;
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[0].data.push(
                        chart.data.datasets[0].label.includes("Flow") 
                          ? Math.random() * 100 + 300 
                          : Math.random() * 2 + 4
                    );
                    chart.update();
                });

                if (Math.random() < 0.2) {
                    const alertMsg = ["Pressure Drop Detected", "Valve Stuck", "Pump Overheat Warning"][Math.floor(Math.random()*3)];
                    const toast = document.createElement('div');
                    toast.textContent = alertMsg;
                    toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg animate-bounce';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            }

            setInterval(updateSensorData, 3000);
            // --- End Chart Section ---


            // Fix: Ensure at least one tab is visible on load
            function showDefaultTab() {
                // Remove 'active' from all tabs
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                // Find hash or default to overview
                let hash = window.location.hash.replace('#', '');
                let defaultTab = document.getElementById(hash) || document.getElementById('overview');
                if (defaultTab) defaultTab.classList.add('active');
            }
            showDefaultTab();

            // Update tab switching logic to always set 'active' class
            function switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                const activeTab = document.getElementById(tabId);
                const activeLink = document.querySelector(`.sidebar-link[data-tab="${tabId}"]`);
                if (activeTab) activeTab.classList.add('active');
                if (activeLink) {
                    activeLink.classList.add('active');
                    headerTitle.textContent = activeLink.querySelector('span').textContent;
                }

                // Lazily load charts when their tab is visible
                switch (tabId) {
                    case 'overview':
                        initWaterChart();
                        break;
                    case 'live-data':
                        initChlorineChart();
                        initFhtcChart();
                        initSensorCharts();
                        break;
                }
            }

            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.dataset.tab;
                    // Update URL hash for better navigation history
                    window.location.hash = tabId;
                    switchTab(tabId);
                });
            });

            // Check for hash on page load to show correct tab
            const currentHash = window.location.hash.substring(1);
            if (currentHash) {
                switchTab(currentHash);
            } else {
                // Set default tab
                switchTab('overview');
            }


            // Chart.js Configuration - This section is now moved and handled by the initializer functions
            // const chartFont = "'Plus Jakarta Sans', sans-serif";
            // Chart.defaults.font.family = chartFont;
            // Chart.defaults.plugins.legend.position = 'bottom';
            
            // Water Supply Chart - MOVED
            // new Chart(document.getElementById('waterChart'), { ... });

            // Chlorine Levels Chart - MOVED
            // new Chart(document.getElementById('chlorineChart'), { ... });

            // FHTC Growth Chart - MOVED
            // new Chart(document.getElementById('fhtcChart'), { ... });

            // --- Panchayat & Village Data ---
            // Example structure: { PanchayatName: [village1, village2, ...], ... }
            const panchayatVillages = {
                "Belthangady": ["Ujire", "Belthangady", "Kaniyoor", "Laila"],
                "Bantwal": ["Sajipamooda", "Bantwal", "Panemangalore", "Kalladka"],
                "Puttur": ["Aryapu", "Puttur", "Nettanige Mudnoor", "Ainekidu"],
                "Sullia": ["Sullia", "Aletty", "Aranthodu"],
                "Mangaluru": ["Mangaluru Rural", "Mulki", "Surathkal", "Bajpe"],
            };

            // Optionally, you can map village data for AI/Charts per village
            const villageData = {
                "Ujire": {
                    supply: [95, 98, 97, 99, 96, 98, 100],
                    chlorine: [0.5, 0.4, 0.6, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1000, 1100, 1150, 1200, 1250],
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 2", status: "In Progress" },
                        { type: "Low Pressure", location: "Market", status: "Resolved" }
                    ],
                    logs: [
                        "FTK Test Passed at School Point",
                        "Pump Maintenance Scheduled for UJ-P1",
                        "Pressure drop detected in Zone B pipeline."
                    ]
                },
                "Sajipamooda": {
                    supply: [60, 61, 62, 59, 63, 62, 62.5],
                    chlorine: [0.4, 0.4, 0.3, 0.3, 0.2, 0.3, 0.3],
                    fhtc: [600, 650, 700, 750, 780],
                    pumpRunningHours: 600,
                    filterLastCleanedDate: '2024-07-01',
                    grievances: [
                        { type: "Contaminated Water", location: "Ward 1", status: "Pending" }
                    ],
                    logs: [
                        "Alert: Low chlorine detected at source SM-BW-01.",
                        "Water sample sent to Taluk lab."
                    ]
                },
                "Aryapu": {
                    supply: [72, 75, 74, 76, 75, 73, 75],
                    chlorine: [0.5, 0.5, 0.4, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [800, 850, 900, 920, 945],
                    pumpRunningHours: 450,
                    filterLastCleanedDate: '2024-07-10',
                    grievances: [],
                    logs: [
                        "5 new FHTC connections approved.",
                        "Pipeline repair underway in Ward 3."
                    ]
                },
                "Belthangady": {
                    supply: [80, 81, 79, 82, 80, 81, 80.5],
                    chlorine: [0.4, 0.3, 0.3, 0.4, 0.3, 0.4, 0.35],
                    fhtc: [1200, 1300, 1350, 1400, 1450],
                    pumpRunningHours: 820,
                    filterLastCleanedDate: '2024-06-20',
                    grievances: [
                        { type: "No Water Supply", location: "Zone B", status: "In Progress" }
                    ],
                    logs: [
                        "Low chlorine detected at BL-TW-01."
                    ]
                },
                "Bantwal": {
                    supply: [70, 71, 70, 72, 69, 70, 70.2],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.45],
                    fhtc: [1100, 1150, 1200, 1250, 1300],
                    pumpRunningHours: 300,
                    filterLastCleanedDate: '2024-07-25',
                    grievances: [],
                    logs: [
                        "Routine inspection completed."
                    ]
                },
                "Puttur": {
                    supply: [82, 84, 85, 83, 85, 86, 85],
                    chlorine: [0.4, 0.4, 0.3, 0.4, 0.4, 0.3, 0.38],
                    fhtc: [1100, 1200, 1250, 1300, 1350],
                    pumpRunningHours: 550,
                    filterLastCleanedDate: '2024-07-05',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 5", status: "Resolved" }
                    ],
                    logs: [
                        "Pipeline repair in progress in Ward 5."
                    ]
                },
                "Sullia": {
                    supply: [60, 58, 59, 61, 60, 62, 60],
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.3, 0.4, 0.32],
                    fhtc: [700, 750, 800, 820, 850],
                    pumpRunningHours: 710,
                    filterLastCleanedDate: '2024-07-01',
                    grievances: [],
                    logs: [
                        "Low pH recorded in water test."
                    ]
                },
                "Mangaluru Rural": {
                    supply: [118, 119, 120, 121, 119, 120, 120],
                    chlorine: [0.5, 0.5, 0.5, 0.6, 0.5, 0.5, 0.5],
                    fhtc: [1800, 1850, 1900, 1950, 1980],
                    pumpRunningHours: 250,
                    filterLastCleanedDate: '2024-07-28',
                    grievances: [],
                    logs: [
                        "FTK test passed at Community Hall."
                    ]
                },
                "Mulki": {
                    supply: [65, 64, 66, 65, 64, 65, 65],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.42],
                    fhtc: [900, 950, 1000, 1050, 1100],
                    pumpRunningHours: 150,
                    filterLastCleanedDate: '2024-07-20',
                    grievances: [],
                    logs: [
                        "Routine pump maintenance done."
                    ]
                },
                "Surathkal": {
                    supply: [98, 99, 100, 101, 99, 100, 100],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.5, 0.5, 0.48],
                    fhtc: [1400, 1450, 1500, 1550, 1600],
                    pumpRunningHours: 400,
                    filterLastCleanedDate: '2024-07-15',
                    grievances: [
                        { type: "Low Water Pressure", location: "Beach Road", status: "Resolved" }
                    ],
                    logs: [
                        "All systems verified operational."
                    ]
                },
                "Kaniyoor": {
                    supply: [70, 72, 71, 73, 74, 72, 71],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [800, 850, 900, 950, 1000],
                    pumpRunningHours: 900,
                    filterLastCleanedDate: '2024-06-10',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 1", status: "Pending" }
                    ],
                    logs: [
                        "Leak detected at main line."
                    ]
                },
                "Laila": {
                    supply: [60, 62, 61, 63, 64, 62, 61],
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 350,
                    filterLastCleanedDate: '2024-07-18',
                    grievances: [],
                    logs: [
                        "Water quality test scheduled."
                    ]
                },
                "Panemangalore": {
                    supply: [80, 81, 82, 83, 82, 81, 80],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1200, 1250, 1300, 1350, 1400],
                    pumpRunningHours: 680,
                    filterLastCleanedDate: '2024-07-02',
                    grievances: [
                        { type: "No Water Supply", location: "Ward 3", status: "In Progress" }
                    ],
                    logs: [
                        "Pump maintenance scheduled."
                    ]
                },
                "Kalladka": {
                    supply: [75, 76, 77, 78, 77, 76, 75],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [1000, 1050, 1100, 1150, 1200],
                    pumpRunningHours: 200,
                    filterLastCleanedDate: '2024-07-22',
                    grievances: [],
                    logs: [
                        "Routine inspection completed."
                    ]
                },
                "Nettanige Mudnoor": {
                    supply: [65, 66, 67, 68, 67, 66, 65],
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [900, 950, 1000, 1050, 1100],
                    pumpRunningHours: 730,
                    filterLastCleanedDate: '2024-06-30',
                    grievances: [
                        { type: "Contaminated Water", location: "Ward 2", status: "Pending" }
                    ],
                    logs: [
                        "Water sample sent to lab."
                    ]
                },
                "Ainekidu": {
                    supply: [60, 61, 62, 63, 62, 61, 60],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [800, 850, 900, 950, 1000],
                    pumpRunningHours: 100,
                    filterLastCleanedDate: '2024-07-29',
                    grievances: [],
                    logs: [
                        "All systems normal."
                    ]
                },
                "Aletty": {
                    supply: [55, 56, 57, 58, 57, 56, 55],
                    chlorine: [0.4, 0.4, 0.5, 0.4, 0.5, 0.4, 0.4],
                    fhtc: [700, 750, 800, 850, 900],
                    pumpRunningHours: 500,
                    filterLastCleanedDate: '2024-07-12',
                    grievances: [
                        { type: "Pipe Leakage", location: "Ward 4", status: "In Progress" }
                    ],
                    logs: [
                        "Leak detected at Ward 4."
                    ]
                },
                "Aranthodu": {
                    supply: [50, 51, 52, 53, 52, 51, 50],
                    chlorine: [0.3, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3],
                    fhtc: [600, 650, 700, 750, 800],
                    pumpRunningHours: 650,
                    filterLastCleanedDate: '2024-07-08',
                    grievances: [],
                    logs: [
                        "Pump maintenance completed."
                    ]
                },
                "Bajpe": {
                    supply: [90, 91, 92, 93, 92, 91, 90],
                    chlorine: [0.5, 0.5, 0.4, 0.5, 0.4, 0.5, 0.5],
                    fhtc: [1500, 1550, 1600, 1650, 1700],
                    pumpRunningHours: 320,
                    filterLastCleanedDate: '2024-07-26',
                    grievances: [
                        { type: "Low Pressure", location: "Sector 1", status: "Resolved" }
                    ],
                    logs: [
                        "Pressure restored in Sector 1."
                    ]
                }
            };

            // Populate Panchayat selector
            const panchayatSelector = document.getElementById('panchayat-selector');
            const villageSelector = document.getElementById('village-selector');
            function populatePanchayats() {
                panchayatSelector.innerHTML = '';
                Object.keys(panchayatVillages).forEach(panchayat => {
                    const opt = document.createElement('option');
                    opt.value = panchayat;
                    opt.textContent = panchayat;
                    panchayatSelector.appendChild(opt);
                });
            }
            function populateVillages(panchayat) {
                villageSelector.innerHTML = '';
                (panchayatVillages[panchayat] || []).forEach(village => {
                    const opt = document.createElement('option');
                    opt.value = village;
                    opt.textContent = village;
                    villageSelector.appendChild(opt);
                });
            }
            // On change, update villages
            panchayatSelector?.addEventListener('change', function() {
                populateVillages(this.value);
                // After changing panchayat, update data for first village in the list
                if (villageSelector.options.length > 0) {
                    villageSelector.selectedIndex = 0;
                    updateDashboardForVillage(villageSelector.value);
                }
            });
            // On village change, update data for AI/charts if needed
            villageSelector?.addEventListener('change', function() {
                updateDashboardForVillage(this.value);
            });
            // Initial population
            populatePanchayats();
            populateVillages(panchayatSelector.value);
            // Show data for the first village on load
            if (villageSelector.options.length > 0) {
                updateDashboardForVillage(villageSelector.value);
            }

            // --- Update Dashboard UI for selected village ---
            function updateDashboardForVillage(village) {
                const data = villageData[village] || { supply: [], chlorine: [], fhtc: [], grievances: [], logs: [] };
                // Update main chart (overview)
                if (waterChartInstance) { waterChartInstance.destroy(); waterChartInstance = null; }
                setCanvasHeight('waterChart');
                waterChartInstance = new Chart(document.getElementById('waterChart'), {
                    type: 'bar',
                    data: {
                        labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                        datasets: [{
                            label: 'Supply (kL)',
                            data: data.supply,
                            backgroundColor: [
                                'rgba(59,130,246,0.85)',
                                'rgba(16,185,129,0.85)',
                                'rgba(249,115,22,0.85)',
                                'rgba(236,72,153,0.85)',
                                'rgba(139,92,246,0.85)',
                                'rgba(251,191,36,0.85)',
                                'rgba(6,182,212,0.85)'
                            ],
                            borderColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 12,
                            hoverBackgroundColor: [
                                'rgba(59,130,246,1)',
                                'rgba(16,185,129,1)',
                                'rgba(249,115,22,1)',
                                'rgba(236,72,153,1)',
                                'rgba(139,92,246,1)',
                                'rgba(251,191,36,1)',
                                'rgba(6,182,212,1)'
                            ]
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
                // Update stat cards
                const totalHouseholds = data.fhtc && data.fhtc.length > 0 ? data.fhtc[data.fhtc.length - 1] : 0;
                document.getElementById('total-households').textContent = totalHouseholds;
                document.getElementById('active-connections').textContent = totalHouseholds;
                // Coverage: percent of days with supply >= 90 (arbitrary threshold for "coverage")
                let coveragePercent = '0%';
                if (data.supply && data.supply.length > 0) {
                    const coveredDays = data.supply.filter(v => v >= 90).length;
                    coveragePercent = Math.round((coveredDays / data.supply.length) * 100) + '%';
                }
                document.getElementById('coverage').textContent = coveragePercent;
                document.getElementById('active-alerts').textContent = data.grievances ? data.grievances.length : 0;

                // Generate and display predictive alerts
                const predictiveAlerts = generatePredictiveAlerts(data);
                displayPredictiveAlerts(predictiveAlerts);
                // --- Dynamic generation of Households Table for Households Tab ---
                // Find the households table body
                const householdsTab = document.getElementById('households');
                if (householdsTab) {
                    const tableBody = document.getElementById('households-table-body');
                    if (tableBody) {
                        // Generate dummy households based on totalHouseholds (limit to 20 for demo)
                        let numHouseholds = Math.min(20, totalHouseholds || 10);
                        // For demo, generate randomized data per household
                        let rowsHtml = '';
                        for (let i = 1; i <= numHouseholds; i++) {
                            const houseId = (village ? village.substring(0,2).toUpperCase() : "XX") + "-H" + String(i).padStart(3,'0');
                            // Random weekly usage and average daily need
                            const weeklyUsage = Math.floor(90 + Math.random() * 80); // 90-170L
                            const avgDailyNeed = Math.floor(110 + Math.random() * 40); // 110-150L
                            let status = '';
                            let statusBg = '';
                            if (weeklyUsage > avgDailyNeed + 15) {
                                status = `<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>Overuse</span>`;
                                statusBg = 'bg-red-100 text-red-800';
                            } else if (weeklyUsage < avgDailyNeed - 15) {
                                status = `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">Deficit</span>`;
                                statusBg = 'bg-yellow-100 text-yellow-800';
                            } else {
                                status = `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Sufficient</span>`;
                                statusBg = 'bg-green-100 text-green-800';
                            }
                            rowsHtml += `
                                <tr class="border-b hover:bg-gray-50" data-usage="${weeklyUsage}" data-need="${avgDailyNeed}">
                                    <td class="p-4 text-gray-800 font-medium">${houseId}</td>
                                    <td class="p-4 text-gray-600">${weeklyUsage} L</td>
                                    <td class="p-4 text-gray-600">${avgDailyNeed} L</td>
                                    <td class="p-4">${status}</td>
                                    <td class="p-4">
                                        <button class="text-blue-600 hover:underline" onclick="openHouseholdModal('${houseId}')">Details</button>
                                    </td>
                                </tr>
                            `;
                        }
                        tableBody.innerHTML = rowsHtml;
                        lucide.createIcons();
                    }
                }
            }

            // For AI: use selected village's data if available
            function getCurrentVillageData() {
                return villageData[villageSelector.value] || demoData;
            }

            // --- Predictive Maintenance AI Simulation ---
            function generatePredictiveAlerts(data) {
                let alerts = [];
                const today = new Date();

                // 1. Pump Maintenance based on running hours
                if (data.pumpRunningHours > 720) { // Threshold for monthly check
                    const scheduleDate = new Date(today);
                    scheduleDate.setDate(today.getDate() + 3);
                    alerts.push({
                        asset: 'Main Pump',
                        issue: `High Running Hours (${data.pumpRunningHours} hrs)`,
                        priority: 'Moderate',
                        action: 'Schedule routine inspection and lubrication.',
                        scheduleDate: scheduleDate.toISOString().split('T')[0]
                    });
                }

                // 2. Low Chlorine Alert
                const avgChlorine = data.chlorine.reduce((a, b) => a + b, 0) / data.chlorine.length;
                if (avgChlorine < 0.35) {
                    const scheduleDate = new Date(today);
                    scheduleDate.setDate(today.getDate() + 1);
                    alerts.push({
                        asset: 'Dosing System',
                        issue: `Consistently Low Chlorine (Avg: ${avgChlorine.toFixed(2)} mg/L)`,
                        priority: 'Urgent',
                        action: 'Check dosing pump, chlorine stock, and injection point.',
                        scheduleDate: scheduleDate.toISOString().split('T')[0]
                    });
                }

                // 3. Widespread Household Overuse (potential leak)
                const overuseHouses = (data.houses || []).filter(h => h.usage > h.requirement * 1.1).length;
                if (data.houses && data.houses.length > 0 && (overuseHouses / data.houses.length) > 0.3) { // >30% of houses
                    const scheduleDate = new Date(today);
                    scheduleDate.setDate(today.getDate());
                     alerts.push({
                        asset: 'Distribution Network',
                        issue: 'Widespread household overuse detected.',
                        priority: 'Urgent',
                        action: 'Initiate leak detection survey in main distribution lines.',
                        scheduleDate: scheduleDate.toISOString().split('T')[0]
                    });
                }

                // 4. Filter Cleaning
                const lastCleaned = new Date(data.filterLastCleanedDate);
                const daysSinceCleaned = (today - lastCleaned) / (1000 * 60 * 60 * 24);
                if (daysSinceCleaned > 85) { // Due every 90 days
                    const scheduleDate = new Date(lastCleaned);
                    scheduleDate.setDate(lastCleaned.getDate() + 90);
                    alerts.push({
                        asset: 'Filter Unit',
                        issue: 'Routine backwashing & cleaning due.',
                        priority: 'Low',
                        action: 'Perform standard filter backwashing procedure.',
                        scheduleDate: scheduleDate.toISOString().split('T')[0]
                    });
                }

                return alerts.sort((a, b) => (a.priority === 'Urgent' ? -1 : 1)); // Sort by priority
            }


            // --- GEMINI API INTEGRATION ---
            const apiKey = "AIzaSyBdNkotzhmT4NEKVqHi8FsriAbOpbIMLBo"; // Keep this empty, it will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            async function callGeminiApi(prompt, button, outputElement) {
                button.disabled = true;
                outputElement.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        outputElement.innerHTML = text.replace(/\*/g, '•');
                    } else {
                        outputElement.textContent = "Could not generate a response. Please try again.";
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    outputElement.textContent = "Failed to generate AI content. Please check the connection and try again.";
                } finally {
                    button.disabled = false;
                }
            }

            function displayPredictiveAlerts(alerts) {
                const tableBody = document.getElementById('maintenance-forecast-table-body');
                if (!tableBody) return;

                if (alerts.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">No predictive alerts at this time. System is stable.</td></tr>`;
                    return;
                }

                let rowsHtml = '';
                alerts.forEach(alert => {
                    let priorityClass = '';
                    let priorityIcon = '';
                    switch (alert.priority) {
                        case 'Urgent':
                            priorityClass = 'bg-red-100 text-red-800';
                            priorityIcon = '<i data-lucide="shield-alert" class="w-4 h-4 mr-1.5"></i>';
                            break;
                        case 'Moderate':
                            priorityClass = 'bg-yellow-100 text-yellow-800';
                            priorityIcon = '<i data-lucide="alert-triangle" class="w-4 h-4 mr-1.5"></i>';
                            break;
                        case 'Low':
                            priorityClass = 'bg-green-100 text-green-800';
                            priorityIcon = '<i data-lucide="info" class="w-4 h-4 mr-1.5"></i>';
                            break;
                    }
                    rowsHtml += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 text-gray-800 font-medium">${alert.asset}</td>
                            <td class="p-3 text-gray-600">${alert.issue}</td>
                            <td class="p-3"><span class="px-2.5 py-1 ${priorityClass} rounded-full text-xs font-semibold flex items-center">${priorityIcon}${alert.priority}</span></td>
                            <td class="p-3 text-gray-600">${alert.action}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rowsHtml;
                lucide.createIcons();
            }
            // --- Gemini AI Integration ---
            // demoData is now only fallback if villageData is missing

            const summaryBtn = document.getElementById('generate-summary-btn');
            const forecastBtn = document.getElementById('generate-forecast-btn');
            if (summaryBtn && forecastBtn) {
                summaryBtn.addEventListener('click', function() {
                    const data = getCurrentVillageData();
                    const grievancesText = data.grievances.length > 0
                        ? data.grievances.map(g => `${g.type} at ${g.location} (Status: ${g.status})`).join(', ')
                        : 'No new grievances';
                    const prompt = `You are a water management expert for a rural Indian village. Based on the following data for the past week, write a concise summary report for the Gram Panchayat in simple language. Highlight key achievements, identify potential issues, and suggest one practical focus area for the upcoming week. Data: Daily Water Supplied ('000 Litres): ${data.supply.join(', ')}. Daily Chlorine Levels (mg/L): ${data.chlorine.join(', ')}. Grievances: ${grievancesText}.`;
                    callGeminiApi(prompt, summaryBtn, document.getElementById('summary-output'));
                });
            }

            // --- Live Data Subtab Logic ---
            const liveSubtabBtns = document.querySelectorAll('.live-subtab-btn');
            const liveSubtabContents = document.querySelectorAll('.live-subtab-content');
            liveSubtabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    liveSubtabBtns.forEach(b => b.classList.remove('border-blue-600', 'text-blue-600'));
                    this.classList.add('border-blue-600', 'text-blue-600');
                    const subtab = this.dataset.subtab;
                    liveSubtabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(subtab).classList.remove('hidden');
                });
            });

            // --- Water Quality Chart & Inputs Binding ---
            let waterQualityChart;
            function initWaterQualityChart(chlorine, ph, turbidity) {
                const ctx = document.getElementById('waterQualityChart');
                if (!ctx) return;
                if (waterQualityChart) {
                    waterQualityChart.destroy();
                    waterQualityChart = null;
                }
                waterQualityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Chlorine (mg/L)', 'pH', 'Turbidity (NTU)'],
                        datasets: [{
                            label: 'Current Value',
                            data: [chlorine, ph, turbidity],
                            backgroundColor: [
                                'linear-gradient(135deg, #818cf8 0%, #38bdf8 100%)',
                                'linear-gradient(135deg, #34d399 0%, #06b6d4 100%)',
                                'linear-gradient(135deg, #fbbf24 0%, #f472b6 100%)'
                            ],
                            borderRadius: 12
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Bind sliders to chart and display
            const inputChlorine = document.getElementById('input-chlorine');
            const inputPh = document.getElementById('input-ph');
            const inputTurbidity = document.getElementById('input-turbidity');
            const displayChlorine = document.getElementById('display-chlorine');
            const displayPh = document.getElementById('display-ph');
            const displayTurbidity = document.getElementById('display-turbidity');

            function updateWaterQualityUI() {
                displayChlorine.textContent = Number(inputChlorine.value).toFixed(2);
                displayPh.textContent = Number(inputPh.value).toFixed(2);
                displayTurbidity.textContent = Number(inputTurbidity.value).toFixed(1);
                initWaterQualityChart(Number(inputChlorine.value), Number(inputPh.value), Number(inputTurbidity.value));
            }

            if (inputChlorine && inputPh && inputTurbidity) {
                inputChlorine.addEventListener('input', updateWaterQualityUI);
                inputPh.addEventListener('input', updateWaterQualityUI);
                inputTurbidity.addEventListener('input', updateWaterQualityUI);
                updateWaterQualityUI();
            }
        });
        // --- Household Modal Logic ---
        // Global variable for household modal chart instance
        let householdModalChartInstance = null;

        // Expose modal functions globally
        window.openHouseholdModal = function(houseId) {
            // Show the modal
            const modal = document.getElementById('household-modal');
            if (!modal) return;
            modal.classList.remove('hidden');

            // Set modal title
            const modalTitle = document.getElementById('household-modal-title');
            if (modalTitle) {
                modalTitle.textContent = `Household ${houseId} - Usage History`;
            }

            // Generate random historical data for demo: 8 weeks
            const weeks = [];
            const usage = [];
            for (let i = 7; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i * 7);
                // Format as "Wk 1", "Wk 2", etc.
                weeks.push(`Week ${8 - i}`);
                // Demo: random usage between 90 and 170L
                usage.push(Math.floor(90 + Math.random() * 80));
            }

            // Render Chart.js line chart in modal
            const ctx = document.getElementById('household-modal-chart');
            if (householdModalChartInstance) {
                householdModalChartInstance.destroy();
                householdModalChartInstance = null;
            }
            if (ctx) {
                ctx.height = 240;
                ctx.style.height = "240px";
                householdModalChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeks,
                        datasets: [{
                            label: 'Weekly Usage (L)',
                            data: usage,
                            borderColor: 'rgba(59,130,246,1)',
                            backgroundColor: 'rgba(59,130,246,0.12)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(59,130,246,1)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        window.closeHouseholdModal = function() {
            const modal = document.getElementById('household-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            // Destroy chart instance
            if (householdModalChartInstance) {
                householdModalChartInstance.destroy();
                householdModalChartInstance = null;
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            // Status update logic
            document.querySelectorAll('.grievance-status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const statusSpan = this.closest('[data-grievance-id]').querySelector('.grievance-status');
                    const val = this.value;
                    statusSpan.textContent = val;
                    statusSpan.className = 'grievance-status px-2 py-1 rounded-full text-xs font-medium';
                    if(val === "Resolved") {
                        statusSpan.classList.add('bg-green-100', 'text-green-800');
                    } else if(val === "In Progress") {
                        statusSpan.classList.add('bg-yellow-100', 'text-yellow-800');
                    }
                });
            });

            // Attachment preview logic
            const attachmentInput = document.getElementById('grievance-attachment');
            const attachmentPreview = document.getElementById('attachment-preview');
            attachmentInput?.addEventListener('change', function() {
                attachmentPreview.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'w-16 h-16 object-cover rounded border';
                    attachmentPreview.appendChild(img);
                });
            });

            // Notification for new grievance
            document.querySelector('#grievances form')?.addEventListener('submit', function(e){
                e.preventDefault();
                const toast = document.createElement('div');
                toast.textContent = "New grievance reported! Check Live Grievance Tracker.";
                toast.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg animate-bounce';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
                // Reset form
                this.reset();
                attachmentPreview.innerHTML = '';
            });

            // --- AI Grievance Modal Logic ---
            const grievanceForm = document.querySelector('#grievances form');
            const aiGrievanceModal = document.getElementById('ai-grievance-modal');
            const closeAIGrievanceModalBtn = document.getElementById('close-ai-grievance-modal-btn');
            const aiGrievanceModalContent = document.getElementById('ai-grievance-modal-content');

            grievanceForm?.addEventListener('submit', function(e) {
                e.preventDefault();
                aiGrievanceModal.classList.remove('hidden');
                aiGrievanceModalContent.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>';

                // Simulate AI analysis
                setTimeout(() => {
                    aiGrievanceModalContent.innerHTML = `
                        <h4 class="font-bold text-lg text-gray-800">Issue: Pipe Leakage near Ward 2 Park</h4>
                        <p><strong>Priority:</strong> <span class="text-red-600 font-semibold">High</span> (Potential for water wastage and contamination)</p>
                        <p><strong>Recommended Action:</strong></p>
                        <ol class="list-decimal list-inside space-y-2 bg-gray-50 p-3 rounded-lg">
                            <li>Immediately dispatch the local plumber to assess the leak's severity.</li>
                            <li>Temporarily shut off the water supply to the affected line to prevent further loss.</li>
                            <li>Notify residents in Ward 2 about the temporary disruption.</li>
                        </ol>`;
                }, 1500);
            });

            closeAIGrievanceModalBtn?.addEventListener('click', () => aiGrievanceModal.classList.add('hidden'));
        });
    </script>
<!-- Household Details Modal -->
<div id="household-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg relative p-6">
    <button onclick="closeHouseholdModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700" aria-label="Close"><i data-lucide="x"></i></button>
    <h2 id="household-modal-title" class="text-xl font-semibold text-gray-800 mb-4">Household Details</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h3 class="text-md font-semibold text-gray-700 mb-2">Usage History (8 Weeks)</h3>
            <canvas id="household-modal-chart"></canvas>
        </div>
        <div class="space-y-4">
            <h3 class="text-md font-semibold text-gray-700">Submit Feedback</h3>
            <form id="household-feedback-form">
                <div>
                    <label class="text-sm font-medium text-gray-600">Satisfaction Rating</label>
                    <div class="flex space-x-1 mt-1 text-yellow-400">
                        <i data-lucide="star" class="w-6 h-6 cursor-pointer"></i>
                        <i data-lucide="star" class="w-6 h-6 cursor-pointer"></i>
                        <i data-lucide="star" class="w-6 h-6 cursor-pointer"></i>
                        <i data-lucide="star" class="w-6 h-6 cursor-pointer"></i>
                        <i data-lucide="star" class="w-6 h-6 cursor-pointer"></i>
                    </div>
                </div>
                <div>
                    <label for="feedback-comments" class="text-sm font-medium text-gray-600">Comments / Issues</label>
                    <textarea id="feedback-comments" rows="3" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Water pressure was low on Tuesday..."></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition">Submit Feedback</button>
            </form>
        </div>
    </div>
  </div>
</div>

<!-- AI Grievance Action Plan Modal -->
<div id="ai-grievance-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[1000] hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full m-4 transform transition-all duration-300 scale-95">
        <button onclick="closeHouseholdModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700" aria-label="Close"><i data-lucide="x"></i></button>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                <i data-lucide="sparkles" class="mr-2 text-blue-500"></i> AI-Suggested Action Plan
            </h3>
            <button id="close-ai-grievance-modal-btn" class="text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="ai-grievance-modal-content" class="text-gray-700 space-y-4 max-h-[60vh] overflow-y-auto p-2"></div>
        <div class="mt-6 flex justify-end space-x-4">
            <button id="confirm-grievance-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 flex items-center">
                <i data-lucide="check-circle" class="mr-2 h-5 w-5"></i> Confirm & Submit Grievance
            </button>
        </div>
    </div>
</div>
</body>
<script>
    // --- Household Modal Logic ---
    // Global variable for household modal chart instance
    let householdModalChartInstance = null;

    // Expose modal functions globally
    window.openHouseholdModal = function(houseId) {
        // Show the modal
        const modal = document.getElementById('household-modal');
        if (!modal) return;
        modal.classList.remove('hidden');

        // Set modal title
        const modalTitle = document.getElementById('household-modal-title');
        if (modalTitle) {
            modalTitle.textContent = `Household ${houseId} - Details`;
        }

        // Generate random historical data for demo: 8 weeks
        const weeks = [];
        const usage = [];
        for (let i = 7; i >= 0; i--) {
            weeks.push(`Wk ${8 - i}`);
            usage.push(Math.floor(90 + Math.random() * 80));
        }

        // Render Chart.js line chart in modal
        const ctx = document.getElementById('household-modal-chart');
        if (householdModalChartInstance) {
            householdModalChartInstance.destroy();
            householdModalChartInstance = null;
        }
        if (ctx) {
            ctx.height = 180;
            ctx.style.height = "180px";
            householdModalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Weekly Usage (L)',
                        data: usage,
                        borderColor: 'rgba(59,130,246,1)',
                        backgroundColor: 'rgba(59,130,246,0.12)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(59,130,246,1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { drawBorder: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        lucide.createIcons();
    }

    window.closeHouseholdModal = function() {
        const modal = document.getElementById('household-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        if (householdModalChartInstance) {
            householdModalChartInstance.destroy();
            householdModalChartInstance = null;
        }
    }

    // --- Water Quality Trend Chart ---
    function initWaterQualityTrendChart() {
        const ctx = document.getElementById('waterQualityTrendChart');
        if (!ctx) return;
        if (waterQualityTrendChart) {
            waterQualityTrendChart.destroy();
        }
        const labels = Array.from({length: 30}, (_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - (29 - i));
            return d;
        });
        setCanvasHeight('waterQualityTrendChart', 220);
        waterQualityTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'pH',
                        data: labels.map(() => 6.8 + Math.random() * 0.7),
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        yAxisID: 'y',
                        tension: 0.4,
                        pointRadius: 0
                    },
                    {
                        label: 'Turbidity (NTU)',
                        data: labels.map(() => 1 + Math.random() * 2),
                        borderColor: 'rgba(249, 115, 22, 0.8)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        pointRadius: 0
                    },
                    {
                        label: 'Fluoride (mg/L)',
                        data: labels.map(() => 0.5 + Math.random() * 0.5),
                        borderColor: 'rgba(16, 185, 129, 0.8)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', tooltipFormat: 'MMM d' },
                        grid: { display: false }
                    },
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'pH' }, min: 6, max: 9 },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'mg/L, NTU' }, grid: { drawOnChartArea: false }, min: 0, max: 5 }
                },
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    // --- Water Quality Alert Logic ---
    function checkWaterQualityAndAlert() {
        const advisoryDiv = document.getElementById('health-advisory-alert');
        const alertContent = document.getElementById('alert-content');
        if (!advisoryDiv || !alertContent) return;

        const values = {
            micro: document.getElementById('input-micro').value,
            fluoride: parseFloat(document.getElementById('input-fluoride').value),
            lead: parseFloat(document.getElementById('input-lead').value),
            arsenic: parseFloat(document.getElementById('input-arsenic').value),
            turbidity: parseFloat(document.getElementById('input-turbidity').value),
            ph: parseFloat(document.getElementById('input-ph').value),
        };

        const limits = {
            micro: 0, // 0 = Not Detected
            fluoride: 1.5, // mg/L
            lead: 10, // µg/L
            arsenic: 10, // µg/L
            turbidity: 5, // NTU
            ph_min: 6.5,
            ph_max: 8.5
        };

        let alerts = [];
        if (values.micro > limits.micro) alerts.push('<b>Microbiological contamination detected.</b> Water is not safe for drinking without boiling.');
        if (values.fluoride > limits.fluoride) alerts.push(`<b>High Fluoride (${values.fluoride} mg/L).</b> Risk of dental fluorosis.`);
        if (values.lead > limits.lead) alerts.push(`<b>High Lead (${values.lead} µg/L).</b> Unsafe for consumption.`);
        if (values.arsenic > limits.arsenic) alerts.push(`<b>High Arsenic (${values.arsenic} µg/L).</b> Unsafe for consumption.`);
        if (values.turbidity > limits.turbidity) alerts.push(`<b>High Turbidity (${values.turbidity} NTU).</b> Water appears cloudy, may harbor pathogens.`);
        if (values.ph < limits.ph_min || values.ph > limits.ph_max) alerts.push(`<b>pH out of range (${values.ph}).</b> May cause pipe corrosion or taste issues.`);

        if (alerts.length > 0) {
            advisoryDiv.className = 'bg-red-50 border-l-4 border-red-500 p-6 rounded-2xl shadow-md';
            alertContent.innerHTML = `<h4 class="font-bold text-red-800 mb-2">Immediate Action Required!</h4><ul class="list-disc list-inside text-red-700 space-y-1">${alerts.map(a => `<li>${a}</li>`).join('')}</ul><p class="text-sm text-gray-600 mt-3"><i data-lucide="smartphone" class="inline-block w-4 h-4 mr-1"></i>Alerts automatically sent to all households.</p>`;
        } else {
            advisoryDiv.className = 'bg-green-50 border-l-4 border-green-500 p-6 rounded-2xl shadow-md';
            alertContent.innerHTML = `<h4 class="font-bold text-green-800">All parameters are within safe limits. Water is safe for consumption.</h4>`;
        }
        lucide.createIcons();
    }

    // Bind sliders to UI and alert function
    document.querySelectorAll('#water-quality-form input, #water-quality-form select').forEach(input => {
        input.addEventListener('input', () => {
            const displayId = `display-${input.id.replace('input-', '')}`;
            const displayEl = document.getElementById(displayId);
            if (displayEl) displayEl.textContent = parseFloat(input.value).toFixed(input.step.includes('.') ? input.step.split('.')[1].length : 0);
            checkWaterQualityAndAlert();
        });
    });
</script>
</html>
